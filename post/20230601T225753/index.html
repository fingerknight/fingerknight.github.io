<!DOCTYPE html>
<html>
<head>
<title>Eww 的配置 - 手指骑士的病房</title>
<link rel="icon" href="/static/favicon.ico"><meta content="text/html;charset=utf-8" http-equiv="Content-Type"><meta content="utf-8" http-equiv="encoding"><link href= "/static/style/style.css" rel="stylesheet" type="text/css" /></head>
<body>
<div id="header">
<div class="home-page">
<a href="/">手指骑士的病房</a></div><div class="nav">
<div class="nav item">
<a href="/tags">标签</a>
</div>
<div class="nav item">
<a href="/archive">归档</a>
</div>
<div class="nav item">
<a href="/about">关于</a>
</div>
<div class="nav item">
<a href="/emacs">Emacs</a>
</div>
</div>
</div>
<div id="main">
<div id="toc">
<h2 class="toc-title"> TOC </h2>
<nav id="TableOfContents">

<ul>
<li>
<a href="#orgcc16f42"> 前言 </a></li>
<li>
<a href="#org3e93f75"> 基础 </a></li>
<li>
<a href="#org47ea318"> 语法 </a>
<ul>
<li>
<a href="#org6251b62"> 变量定义 </a>
<ul>
<li>
<a href="#orge4a9a1e"> defvar </a></li>
<li>
<a href="#org9f50d35"> deflisten </a></li>
<li>
<a href="#org8b9c057"> defpoll </a></li>
</ul>
</li>
<li>
<a href="#org0133666"> 变量使用 </a></li>
</ul>
</li>
<li>
<a href="#org0e5bb58"> 窗口 </a></li>
<li>
<a href="#orgc43f0ef"> 状态栏窗口框架 </a></li>
<li>
<a href="#org99ae775"> 功能模块 </a>
<ul>
<li>
<a href="#org1535f35"> 工作区展示 </a></li>
<li>
<a href="#org6b8633c"> 日期时间 </a></li>
<li>
<a href="#org7fadc2d"> 系统状态 </a></li>
<li>
<a href="#org51abfbc"> 后台音乐 MPD </a></li>
<li>
<a href="#org81050e5"> 电池状态 </a></li>
<li>
<a href="#orgb8ea0ee"> 灯光 </a></li>
<li>
<a href="#org0422efc"> 音量模块 </a></li>
<li>
<a href="#org89e533e"> 用户模块 </a></li>
</ul>
</li>
<li>
<a href="#org3636e8f"> 样式 </a></li>
<li>
<a href="#org23b9382"> 后记 </a></li>
</ul>
</nav>
</div>
<div id="page">
<div id="preamble" class="status"><link rel="stylesheet" href="/static/pygments/dracula.css"><h1 class="post-title"> Eww 的配置 </h1>
<div class="post-date">2023-08-26</div>
<div class="taglist"><a href="/tag/archlinux"> #archlinux </a>
<a href="/tag/bspwm"> #bspwm </a>
<a href="/tag/eww"> #eww </a>
<a href="/tag/qtile"> #qtile </a>
</div>
</div>
<div id="content">

<div id="outline-container-orgcc16f42" class="outline-2">
<h2 id="orgcc16f42">前言</h2>
<div class="outline-text-2" id="text-orgcc16f42">
<p>
<a href="https://elkowar.github.io/eww/eww.html" target="_blank">EWW</a> 是一个窗口模块工具，可以用于生成各式各样的 widget. 不单单是状态栏，就是可以当作一个类 gtk 等的工具使用，自己做一些窗口样式。
</p>

<p>
之前考虑的是 Waybar, 一个配置相对简单，但是功能也相对粗糙的状态栏样式。本来好好的，结果看到 Hyprland 的名人墙（Wall of Fame ），各种花哨美丽的样式，一下子就心动了。看了大佬的配置，发现用的是 eww. 在前也在 Hyprland 的 <a href="https://github.com/hyprland-community/awesome-hyprland" target="_blank">awesome list</a> 看过。当时并不感冒。
</p>

<p>
这篇文章之所以出现是因为：
</p>
<ol class="org-ol">
<li>eww 的配置相对复杂</li>
<li>eww 的文档并不是很详细，有许多功能是自己看大佬的配置和去网上各种翻才找到</li>
</ol>

<p>
配合 eww 的文档使用。
</p>
</div>
</div>

<div id="outline-container-org3e93f75" class="outline-2">
<h2 id="org3e93f75">基础</h2>
<div class="outline-text-2" id="text-org3e93f75">
<p>
配置目录在 <code>~/.config/eww</code>, 配置文件是 <code>/.config/eww/eww.yuck</code>, 样式文件是 <code>/.config/eww/eww.scss</code>.
</p>
</div>
</div>

<div id="outline-container-org47ea318" class="outline-2">
<h2 id="org47ea318">语法</h2>
<div class="outline-text-2" id="text-org47ea318">
<p>
eww 用的是是一套自己的语言 yuck. 本质上就是一种 lisp 的方言，写 Emacs Lisp 写多了就没什么压力。
</p>
</div>


<div id="outline-container-org6251b62" class="outline-3">
<h3 id="org6251b62">变量定义</h3>
<div class="outline-text-3" id="text-org6251b62">
<p>
Yuck 中有三种变量定义： <code>defvar</code>, <code>deflisten</code> 和 <code>defpoll</code>.
</p>
</div>

<div id="outline-container-orge4a9a1e" class="outline-4">
<h4 id="orge4a9a1e">defvar</h4>
<div class="outline-text-4" id="text-orge4a9a1e">
<p>
语法： <code>(defvar name "string")</code>
</p>

<p>
定义普通变量，输入值是字符串。后续可以使用 <code>${EWW_CMD} update name='new value'</code> 来重新赋值。
</p>
</div>
</div>

<div id="outline-container-org9f50d35" class="outline-4">
<h4 id="org9f50d35">deflisten</h4>
<div class="outline-text-4" id="text-org9f50d35">
<p>
语法： <code>(deflisten name [:initial "string"] "cmd")</code>
</p>

<p>
定义一个监听变量。传入的 <code>cmd</code> 是命令的路径，可以用相对路径，相对于配置目录 <code>~/.config/eww/</code>, 比如可以创建一个目录， <code>/.config/eww/scripts</code>, 把脚本都放在下面，就可以直接 <code>"scripts/xxx"</code> 了。
</p>

<p>
工作原理是，这个命令是常驻的，eww 把它打印的每一行输出作为值刷新监听变量。
</p>

<p>
打个比方，有一个文件 <code>/tmp/test</code>, 定义一个监听变量 <code>(deflisten test-var "tail -F /tmp/test")</code>. 这时某个外部程序执行，将字符串 <code>new string</code> 写入到这个文件中。 <code>tail -F</code> 会把输出打印到标准输出流，这时 eww 会读取它，并把 <code>new string</code> 赋值给 <code>test-var</code>.
</p>

<p>
因为是监听的输出，对于没有初始输出的程序，可以给一个 <code>:initial</code> 作为初始字符串。它就是一个普通的字符串，不是命令。如果要用一定要在 <code>cmd</code> 之前。
</p>
</div>
</div>

<div id="outline-container-org8b9c057" class="outline-4">
<h4 id="org8b9c057">defpoll</h4>
<div class="outline-text-4" id="text-org8b9c057">
<p>
语法： <code>(defpoll name :interval "5s" [:initial "string" :run-while var] "cmd")</code>
</p>

<p>
定义一个拉取变量（我不知道咋翻译比较好）。顾名思义，就是就是定时执行一个命令，获取它的输出。时间区间也是一个字符串，数字跟单位。
</p>

<p>
同样可以给一个初始值。
</p>

<p>
<code>:run-while</code> 输入是一个变量名，当变量名为真的时候执行一次拉取。这个是用于某些没到时间，但是触发了条件的时候使用。
</p>
</div>
</div>
</div>

<div id="outline-container-org0133666" class="outline-3">
<h3 id="org0133666">变量使用</h3>
<div class="outline-text-3" id="text-org0133666">
<p>
eww 的变量使用是定义在一对花括号 <code>{}</code> 中.
</p>
<ul class="org-ul">
<li>直接用花括号来调用： <code>{cond ? "real" : "fake"}</code></li>
<li>在字符串中使用： <code>"${cond ? 'real' : 'fake'}"</code></li>
</ul>

<p>
可以使用一些简单的算数运算和布尔运算。这里面的数字和字符串是不分家的。具体的使用可以参考一下文档：<a href="https://elkowar.github.io/eww/expression_language.html" target="_blank">https://elkowar.github.io/eww/expression_language.html</a>.
</p>
<ul class="org-ul">
<li>三元运算符： <code>{something == "another" ? "true" : "false"}</code></li>
<li>列表： <code>{var[idx]}</code></li>
<li>字典（对象）： <code>var['key']</code></li>
</ul>

<p>
对于程序的输出打印，如果打印的是 JSON 字符串，可以直接读入当作对象使用。后面会说到。
</p>
</div>
</div>
</div>

<div id="outline-container-org0e5bb58" class="outline-2">
<h2 id="org0e5bb58">窗口</h2>
<div class="outline-text-2" id="text-org0e5bb58">
<p>
ewww 的最大的定义是定义一个窗口 (window), 然后往下一层是模块 (widget). 一个窗口可以容纳多个模块，而一个模块同样可以嵌套和包含多个子模块。
</p>

<p>
窗口定义函数是 <code>defwindow</code>, 模块定义函数是 <code>defwidget</code>. 具体参数可以看文档，我接下来直接把我自己的设计过程讲解，配合着看。
</p>
</div>
</div>

<div id="outline-container-orgc43f0ef" class="outline-2">
<h2 id="orgc43f0ef">状态栏窗口框架</h2>
<div class="outline-text-2" id="text-orgc43f0ef">
<p>
整个框架的编写参考了大佬的配置：<a href="https://github.com/end-4/dots-hyprland" target="_blank">GitHub - end-4/dots-hyprland: unleashing the power of eww!</a>。它是 Wall of Fame 的编号一，一上来就看到他的作品<sup>[<a id="fnr:1.1" class="footref" href="#fn:1">1</a>]</sup> 。
</p>

<p>
这是我的 <code>~/.config/eww/eww.yuck</code>.
</p>
<div class="org-src-container">
<pre class="lisp"><span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/music.yuck&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/workspace.yuck&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/volume.yuck&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/system.yuck&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/weather.yuck&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/backlight.yuck&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/power.yuck&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/user.yuck&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/datetime.yuck&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/pomodoro.yuck&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/net.yuck&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">left</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">box</span>
<span class="w">   </span><span class="ss">:halign</span><span class="w"> </span><span class="s">&quot;start&quot;</span>
<span class="w">   </span><span class="ss">:spacing</span><span class="w"> </span><span class="mi">10</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;container&quot;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">workspace</span><span class="p">)</span>
<span class="w">   </span><span class="p">))</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">mid</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">box</span>
<span class="w">   </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="nv">false</span>
<span class="w">   </span><span class="ss">:halign</span><span class="w"> </span><span class="s">&quot;center&quot;</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;container&quot;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">    </span><span class="ss">:onhover</span><span class="w"> </span><span class="s">&quot;eww update show-date=true; eww update show-sec=true&quot;</span><span class="w"> 		</span>
<span class="w">    </span><span class="ss">:onhoverlost</span><span class="w"> </span><span class="s">&quot;eww update show-date=false; eww update show-sec=false&quot;</span>
<span class="w">    </span><span class="ss">:onscroll</span><span class="w"> </span><span class="s">&quot;scripts/mid {}&quot;</span>

<span class="w">    </span><span class="p">(</span><span class="nv">overlay</span>
<span class="w">     </span><span class="ss">:width</span><span class="w"> </span><span class="mi">200</span>
<span class="w">     </span><span class="p">(</span><span class="nv">datetime</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="nv">pomodoro</span><span class="p">)</span>
<span class="w">     </span><span class="p">))))</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">right</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">box</span>
<span class="w">   </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="nv">false</span>
<span class="w">   </span><span class="ss">:halign</span><span class="w"> </span><span class="s">&quot;end&quot;</span>
<span class="w">   </span><span class="ss">:spacing</span><span class="w"> </span><span class="mi">10</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;container&quot;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">net-icon</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nv">system</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nv">music</span><span class="p">)</span>
<span class="w">   </span><span class="c1">;; (weather)</span>
<span class="w">   </span><span class="p">(</span><span class="nv">power</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nv">backlight</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nv">volume</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nv">user</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">bar</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">centerbox</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;bar&quot;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">left</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nv">mid</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nv">right</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">defwindow</span><span class="w"> </span><span class="nv">bar</span>
<span class="w">  </span><span class="ss">:stacking</span><span class="w"> </span><span class="s">&quot;bg&quot;</span>
<span class="w">  </span><span class="ss">:monitor</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="ss">:exclusive</span><span class="w"> </span><span class="nv">true</span>
<span class="w">  </span><span class="ss">:geometry</span><span class="w"> </span><span class="p">(</span><span class="nv">geometry</span>
<span class="w">             </span><span class="ss">:x</span><span class="w"> </span><span class="s">&quot;0&quot;</span>
<span class="w">             </span><span class="ss">:y</span><span class="w"> </span><span class="s">&quot;5&quot;</span>
<span class="w">             </span><span class="ss">:width</span><span class="w"> </span><span class="s">&quot;1894px&quot;</span>
<span class="w">             </span><span class="ss">:height</span><span class="w"> </span><span class="s">&quot;26px&quot;</span>
<span class="w">             </span><span class="ss">:anchor</span><span class="w"> </span><span class="s">&quot;top center&quot;</span>
<span class="w">             </span><span class="p">)</span>
<span class="w">  </span><span class="ss">:windowtype</span><span class="w"> </span><span class="s">&quot;dock&quot;</span>
<span class="w">  </span><span class="ss">:wm-ignore</span><span class="w"> </span><span class="nv">true</span>
<span class="w">  </span><span class="p">(</span><span class="nv">bar</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span></pre>
</div>

<p>
首先定义了一个窗口 <code>bar</code>, 层次在 <code>fg</code>, 显示器在第一个（编号 0）。 <code>exclusive</code> 为真表示它不会与其它窗口重叠。设定一些位置、大小参数。最后是调用一个模块也叫做 <code>bar</code>.
</p>

<p>
而模块 <code>bar</code> 的定义呢就在前面。它是一个 <code>centerbox</code>, 必须包含三个子模块，分别是左边的模块、中间的模块和右边的模块。这是再把这三个子模块调用上。
</p>

<p>
<code>left</code>, <code>center</code>, <code>right</code> 这三个模块都是基础的 <code>box</code>, 设定 <code>space-evenly</code> 为假，不让它自动均分子模块。然后再调用相应的功能模块。
</p>

<p>
通过 <code>(include "file")</code> 来导入模块。 
</p>
</div>
</div>

<div id="outline-container-org99ae775" class="outline-2">
<h2 id="org99ae775">功能模块</h2>
<div class="outline-text-2" id="text-org99ae775">
</div>
<div id="outline-container-org1535f35" class="outline-3">
<h3 id="org1535f35">工作区展示</h3>
<div class="outline-text-3" id="text-org1535f35">
<p>
配置工作区 <code>modules/workspace.yuck</code>
</p>
<div class="org-src-container">
<pre class="lisp"><span class="p">(</span><span class="nv">include</span><span class="w"> </span><span class="s">&quot;./modules/mail.yuck&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">workspace-numbers</span><span class="w"> </span><span class="s">&quot;[1,2,3,4,5,6,7,8,9]&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">workspace-numbers-icons</span><span class="w"> </span><span class="ss">&#39;[</span><span class="s">&quot; &quot;</span><span class="o">,</span><span class="s">&quot; &quot;</span><span class="o">,</span><span class="s">&quot; &quot;</span><span class="o">,</span><span class="s">&quot; &quot;</span><span class="o">,</span><span class="s">&quot; &quot;</span><span class="o">,</span><span class="s">&quot; &quot;</span><span class="o">,</span><span class="s">&quot; &quot;</span><span class="o">,</span><span class="s">&quot; &quot;</span><span class="o">,</span><span class="s">&quot; &quot;</span><span class="nv">]</span><span class="o">&#39;</span><span class="p">)</span>
<span class="c1">;; (defvar actived-workspace &quot;1&quot;)󰾱 󱥂 󰍥 </span>
<span class="p">(</span><span class="nv">deflisten</span><span class="w"> </span><span class="nv">actived-workspace</span>
<span class="w">  </span><span class="ss">:initial</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">  </span><span class="s">&quot;scripts/workspace&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">deflisten</span><span class="w"> </span><span class="nv">non-empty-workspaces</span>
<span class="w">  </span><span class="ss">:initial</span><span class="w"> </span><span class="s">&quot;[false, false, false, false, false, false, false, false ,false, false]&quot;</span>
<span class="w">  </span><span class="s">&quot;scripts/workspace ne&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">workspace</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">box</span>
<span class="w">   </span><span class="ss">:spacing</span><span class="w"> </span><span class="mi">4</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;workspace&quot;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">workspace-numbers</span><span class="w">        </span>
<span class="w">     </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">      </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;item${actived-workspace == i ? &#39; active&#39; : non-empty-workspaces[i - 1] ? &#39; window&#39; : &#39;&#39;}&quot;</span>
<span class="w">      </span><span class="ss">:cursor</span><span class="w"> </span><span class="nv">{actived-workspace</span><span class="w"> </span><span class="nv">==</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">?</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span><span class="nv">}</span>
<span class="w">      </span><span class="ss">:onclick</span><span class="w"> </span><span class="s">&quot;scripts/workspace mt ${i}&quot;</span>
<span class="w">      </span><span class="ss">:width</span><span class="w"> </span><span class="mi">28</span>
<span class="w">      </span><span class="ss">:height</span><span class="w"> </span><span class="mi">24</span>
<span class="w">      </span><span class="ss">:style</span><span class="w"> </span><span class="s">&quot;border-radius: 5px&quot;</span>
<span class="w">      </span><span class="nv">{workspace-numbers-icons[i</span><span class="w"> </span><span class="nb">-</span><span class="w"> </span><span class="nv">1]}</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nv">mail</span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span></pre>
</div>

<p>
先定义了一个索引数组  <code>workspace-numbers</code> 和一个图标数组 <code>workspace-numbers-icons</code>. 然后使用 eww 的 for 循环快速定义 10 个工作区的模块。
</p>

<p>
目前窗口管理器用的是 <a href="https://github.com/qtile/qtile" target="_blank">Qtile</a>, 它可以通过命令行来查询工作区信息，也可以在配置中设置钩子来更新 eww 的变量，我选用的是后者的。
</p>

<p>
在 Qtile 配置文件中定义如下钩子：
</p>

<div class="org-src-container">
<pre class="python"><span class="nd">@hook</span><span class="o">.</span><span class="n">subscribe</span><span class="o">.</span><span class="n">setgroup</span>
<span class="k">def</span> <span class="nf">eww_workspace</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">qtile</span><span class="o">.</span><span class="n">groups</span>
    <span class="n">ne</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">windows</span><span class="p">:</span>
            <span class="n">ne</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">screen</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;eww&quot;</span><span class="p">,</span><span class="s2">&quot;update&quot;</span><span class="p">,</span><span class="s2">&quot;actived-workspace=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ws</span><span class="p">])</span>

    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;eww&quot;</span><span class="p">,</span><span class="s2">&quot;update&quot;</span><span class="p">,</span><span class="s1">&#39;non-empty-workspaces=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">ne</span><span class="p">)])</span></pre>
</div>

<p>
<code>setgroup</code> 是在工作区改变时触发的钩子，查询两个信息，当前的工作区和所有有窗口的工作区，对所有工作区做一个 for 循环，如果 <code>g.windows</code> 非空就说明有工作区有窗口， <code>g.screen</code> 为真说明该工作区是出现在屏幕下（也就是当前工作区）。然后用 <code>subprocess.run</code> 调用命令，使用 <code>eww update var=val</code> 来更新 eww 的变量。
</p>

<p>
每个模块设置 <code>class</code> 参数用来给 SCSS 调样式。 <code>cursor</code> 参数定义鼠标指针，如果是指向当前工作区不变化，指向其他工作区为点击样式。 <code>onclick</code> 定义了点击行为，如果点击当前工作区不动作，点击其他工作区用 Qtile 的命令行接口去切换工作区。但是这个命令行工具有延迟，单击要等一会才会切换，不知道是不是因为 qtile 的配置没调好。无伤大雅，平时几乎不会真的用鼠标去点击切换，这个功能只能说是为了突出一个完整性。
</p>

<p>
效果展示：
</p>


<figure id="orgca02468">
<a href="/assets/849da2197cf9c6363dd521e44da23908.png" target="_blank" target="_blank"><img src="/assets/849da2197cf9c6363dd521e44da23908.png" alt="849da2197cf9c6363dd521e44da23908.png"></a>

</figure>
</div>
</div>
<div id="outline-container-org6b8633c" class="outline-3">
<h3 id="org6b8633c">日期时间</h3>
<div class="outline-text-3" id="text-org6b8633c">
<p>
日期时间配置 <code>~/.config/eww/modules/datetime.yuck</code>
</p>

<div class="org-src-container">
<pre class="lisp"><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">show-datetime</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">show-date</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">show-sec</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="p">(</span><span class="nv">defpoll</span><span class="w"> </span><span class="nv">cur</span><span class="w"> </span><span class="ss">:interval</span><span class="w"> </span><span class="s">&quot;1s&quot;</span><span class="w"> </span><span class="ss">:initial</span><span class="w"> </span><span class="s">&quot;{}&quot;</span>
<span class="w">  </span><span class="s">&quot;scripts/datetime&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">datetime</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">   </span><span class="ss">:onhover</span><span class="w"> </span><span class="s">&quot;eww update show-date=true; eww update show-sec=true&quot;</span><span class="w"> 		</span>
<span class="w">   </span><span class="ss">:onhoverlost</span><span class="w"> </span><span class="s">&quot;eww update show-date=false; eww update show-sec=false&quot;</span>
<span class="w">   </span><span class="ss">:onclick</span><span class="w"> </span><span class="s">&quot;emacs -f calendar &amp;&quot;</span>
<span class="w">   </span><span class="ss">:cursor</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;datetime&quot;</span>
<span class="w">   </span><span class="ss">:visible</span><span class="w"> </span><span class="nv">show-datetime</span>
<span class="w">   </span><span class="ss">:halign</span><span class="w"> </span><span class="s">&quot;center&quot;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">box</span>
<span class="w">    </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="s">&quot;false&quot;</span>

<span class="w">    </span><span class="p">(</span><span class="nv">revealer</span>
<span class="w">     </span><span class="ss">:transition</span><span class="w"> </span><span class="s">&quot;slideleft&quot;</span>
<span class="w">     </span><span class="ss">:reveal</span><span class="w"> </span><span class="nv">{show-date}</span>
<span class="w">     </span><span class="ss">:duration</span><span class="w"> </span><span class="s">&quot;400ms&quot;</span>
<span class="w">     </span><span class="p">(</span><span class="nv">label</span>
<span class="w">      </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;date&quot;</span>
<span class="w">      </span><span class="ss">:text</span><span class="w"> </span><span class="s">&quot;${cur[&quot;</span><span class="nv">date</span><span class="s">&quot;]} &quot;</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">label</span>
<span class="w">     </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;time&quot;</span>
<span class="w">     </span><span class="ss">:text</span><span class="w"> </span><span class="nv">{cur[</span><span class="s">&quot;time&quot;</span><span class="nv">]}</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">revealer</span>
<span class="w">     </span><span class="ss">:transition</span><span class="w"> </span><span class="s">&quot;slideright&quot;</span>
<span class="w">     </span><span class="ss">:reveal</span><span class="w"> </span><span class="nv">{show-sec}</span>
<span class="w">     </span><span class="ss">:duration</span><span class="w"> </span><span class="s">&quot;400ms&quot;</span>
<span class="w">     </span><span class="p">(</span><span class="nv">label</span>
<span class="w">      </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;second&quot;</span>
<span class="w">      </span><span class="ss">:markup</span><span class="w"> </span><span class="ss">&#39;&lt;sup&gt;:${cur[</span><span class="s">&quot;second&quot;</span><span class="nv">]}&lt;/sup&gt;</span><span class="o">&#39;</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span></pre>
</div>

<p>
定义了三个变量，其中两个是展示变量，用来控制日期和秒数的展示，有一个拉取变量，每秒获取当前时间。
</p>

<p>
首先注意到这里使用了 <code>revealer</code> 模块，它是一个滑动展示模块（我不知道专业术语叫啥），通过传参 <code>reveal</code> 控制：传入真，控件显示；传入假，控件隐藏。 <code>transition</code> 用来控制滑动的方向，我对日期和秒数分别设置了左右两个方向，效果便是默认显示钟点（时-分），鼠标悬停两边展开，左边显示日期，右边显示秒数。
</p>

<p>
鼠标悬停动作用的是 <code>eventbox</code> 的 <code>onhover</code> 和 <code>onhoverlost</code>, 前者鼠标悬停时触发一次，后者鼠标悬停离开后触发一次。通过更新传入到 <code>reveal</code> 的变量来实现滑动展示。
</p>

<p>
多说无以，效果如图：
</p>


<figure id="orged2ce90">
<a href="/assets/5421b66258c807c011f35d7739bbad2b.gif" target="_blank" target="_blank"><img src="/assets/5421b66258c807c011f35d7739bbad2b.gif" alt="5421b66258c807c011f35d7739bbad2b.gif"></a>

</figure>
</div>
</div>

<div id="outline-container-org7fadc2d" class="outline-3">
<h3 id="org7fadc2d">系统状态</h3>
<div class="outline-text-3" id="text-org7fadc2d">
<p>
系统状态配置 <code>~/.config/eww/modules/system.yuck</code>
</p>

<div class="org-src-container">
<pre class="lisp"><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">show-system</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="p">(</span><span class="nv">defpoll</span><span class="w"> </span><span class="nv">temp</span><span class="w"> </span><span class="ss">:interval</span><span class="w"> </span><span class="s">&quot;2s&quot;</span><span class="w"> </span><span class="ss">:initial</span><span class="w"> </span><span class="s">&quot;0&quot;</span>
<span class="w">  </span><span class="s">&quot;cat /sys/class/thermal/thermal_zone2/temp&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">system</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">   </span><span class="ss">:onhover</span><span class="w"> </span><span class="s">&quot;eww update show-system=true&quot;</span><span class="w"> 		</span>
<span class="w">   </span><span class="ss">:onhoverlost</span><span class="w"> </span><span class="s">&quot;eww update show-system=false&quot;</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;system&quot;</span>
<span class="w">   </span><span class="ss">:style</span><span class="w"> </span><span class="s">&quot;margin-left: 10px&quot;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">box</span>
<span class="w">    </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="nv">false</span>
<span class="w">    </span><span class="p">(</span><span class="nv">revealer</span>
<span class="w">     </span><span class="ss">:transition</span><span class="w"> </span><span class="s">&quot;slideright&quot;</span>
<span class="w">     </span><span class="ss">:reveal</span><span class="w"> </span><span class="nv">{show-system}</span>
<span class="w">     </span><span class="ss">:duration</span><span class="w"> </span><span class="s">&quot;400ms&quot;</span>
<span class="w">     </span><span class="p">(</span><span class="nv">box</span>
<span class="w">      </span><span class="p">(</span><span class="nv">box</span>
<span class="w">       </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="nv">false</span>
<span class="w">       </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;item&quot;</span>
<span class="w">       </span><span class="p">(</span><span class="nv">label</span>
<span class="w">        </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;icon&quot;</span>
<span class="w">        </span><span class="ss">:text</span><span class="w"> </span><span class="s">&quot; &quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nv">label</span>
<span class="w">        </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;text&quot;</span>
<span class="w">        </span><span class="ss">:text</span><span class="w"> </span><span class="ss">&#39;${round</span><span class="p">(</span><span class="nv">temp/1000,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="nv">}</span><span class="err">°</span><span class="nv">C</span><span class="o">&#39;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">       </span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">box</span>
<span class="w">       </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="nv">false</span>
<span class="w">       </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;item&quot;</span>
<span class="w">       </span><span class="p">(</span><span class="nv">label</span>
<span class="w">        </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;icon&quot;</span>
<span class="w">        </span><span class="ss">:text</span><span class="w"> </span><span class="s">&quot; &quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nv">label</span>
<span class="w">        </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;text&quot;</span>
<span class="w">        </span><span class="ss">:text</span><span class="w"> </span><span class="ss">&#39;${round</span><span class="p">(</span><span class="nv">EWW_CPU[</span><span class="s">&quot;avg&quot;</span><span class="nv">],2</span><span class="p">)</span><span class="nv">}%</span><span class="o">&#39;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">       </span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">box</span>
<span class="w">       </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="nv">false</span>
<span class="w">       </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;item&quot;</span>
<span class="w">       </span><span class="p">(</span><span class="nv">label</span>
<span class="w">        </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;icon&quot;</span>
<span class="w">        </span><span class="ss">:text</span><span class="w"> </span><span class="s">&quot;󰒋 &quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nv">label</span>
<span class="w">        </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;text&quot;</span>
<span class="w">        </span><span class="ss">:text</span><span class="w"> </span><span class="ss">&#39;${round</span><span class="p">(</span><span class="nv">EWW_RAM[</span><span class="s">&quot;used_mem_perc&quot;</span><span class="nv">],2</span><span class="p">)</span><span class="nv">}%</span><span class="o">&#39;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">       </span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">     </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;icon&quot;</span>
<span class="w">     </span><span class="ss">:tooltip</span><span class="w"> </span><span class="s">&quot;Open btop&quot;</span>
<span class="w">     </span><span class="ss">:cursor</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span>
<span class="w">     </span><span class="ss">:width</span><span class="w"> </span><span class="s">&quot;24&quot;</span>
<span class="w">     </span><span class="ss">:height</span><span class="w"> </span><span class="s">&quot;24&quot;</span>
<span class="w">     </span><span class="ss">:onclick</span><span class="w"> </span><span class="s">&quot;alacritty -e btop &amp;&quot;</span>
<span class="w">     </span><span class="s">&quot; &quot;</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span></pre>
</div>

<p>
这里同样用到了 <code>revealer</code> 模块，鼠标悬停的时候才展示。系统变量 eww 已经给了一些魔法变量记录了相应的值，直接调用即可。
</p>

<p>
我这里只选择了三个系统状态：温度、CPU 使用率和内存使用率。
</p>

<p>
eww 提供了 <code>EWW_TEMPS</code> 变量，它记录了各种详细的温度信息。但是我使用的时候会遇到解析不了的问题，于是写了个拉取变量，通过 cat 系统文件下的记录来获取温度。
</p>

<p>
另外两个用的就是 <code>EWW_CPU</code> 和 <code>EWW_RAM</code> 来获取状态。
</p>

<p>
效果如图：
</p>


<figure id="org3301bf4">
<a href="/assets/80a65a27102eb79b0e2eb23d0f51dab8.gif" target="_blank" target="_blank"><img src="/assets/80a65a27102eb79b0e2eb23d0f51dab8.gif" alt="80a65a27102eb79b0e2eb23d0f51dab8.gif"></a>

</figure>
</div>
</div>

<div id="outline-container-org51abfbc" class="outline-3">
<h3 id="org51abfbc">后台音乐 MPD</h3>
<div class="outline-text-3" id="text-org51abfbc">
<p>
安装和配置详见《<a href="/post/20230602T005833" target="_blank">Arch Linux 下 MPD 的配置</a>》。
</p>

<p>
MPD 模块配置 <code>~/.config/eww/modules/music.yuck</code>.
</p>

<div class="org-src-container">
<pre class="lisp"><span class="p">(</span><span class="nv">deflisten</span><span class="w"> </span><span class="nv">music-status</span>
<span class="w">  </span><span class="ss">:initial</span><span class="w"> </span><span class="ss">&#39;{</span><span class="s">&quot;title&quot;</span><span class="err">:</span><span class="s">&quot;&quot;</span><span class="o">,</span><span class="s">&quot;artist&quot;</span><span class="err">:</span><span class="s">&quot;&quot;</span><span class="o">,</span><span class="s">&quot;state&quot;</span><span class="ss">:0}</span><span class="o">&#39;</span>
<span class="w">  </span><span class="s">&quot;scripts/music status&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">show-music</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">music</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">box</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;music&quot;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">    </span><span class="ss">:onhover</span><span class="w"> </span><span class="s">&quot;eww update show-music=true&quot;</span><span class="w"> 		</span>
<span class="w">    </span><span class="ss">:onhoverlost</span><span class="w"> </span><span class="s">&quot;eww update show-music=false&quot;</span>
<span class="w">    </span><span class="ss">:onscroll</span><span class="w"> </span><span class="s">&quot;scripts/music {}&quot;</span>
<span class="w">    </span><span class="ss">:onclick</span><span class="w"> </span><span class="s">&quot;scripts/music toggle&quot;</span>
<span class="w">    </span><span class="ss">:onrightclick</span><span class="w"> </span><span class="s">&quot;scripts/music gui&quot;</span>
<span class="w">    </span><span class="ss">:cursor</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="nv">box</span>
<span class="w">     </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="nv">false</span>
<span class="w">     </span><span class="p">(</span><span class="nv">revealer</span>
<span class="w">      </span><span class="ss">:transition</span><span class="w"> </span><span class="s">&quot;slideleft&quot;</span>
<span class="w">      </span><span class="ss">:reveal</span><span class="w"> </span><span class="nv">{show-music}</span>
<span class="w">      </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;info&quot;</span>
<span class="w">      </span><span class="p">(</span><span class="nv">label</span>
<span class="w">       </span><span class="ss">:limit-width</span><span class="w"> </span><span class="mi">30</span>
<span class="w">       </span><span class="ss">:text</span><span class="w"> </span><span class="ss">&#39;${music-status[</span><span class="s">&quot;artist&quot;</span><span class="nv">]}</span><span class="w"> </span><span class="nb">-</span><span class="w"> </span><span class="nv">${music-status[</span><span class="s">&quot;title&quot;</span><span class="nv">]}</span><span class="o">&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="nv">label</span>
<span class="w">      </span><span class="ss">:class</span><span class="w"> </span><span class="nv">{music-status[</span><span class="s">&quot;state&quot;</span><span class="nv">]</span><span class="w"> </span><span class="nv">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">?</span><span class="w"> </span><span class="s">&quot;icon playing&quot;</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="s">&quot;icon&quot;</span><span class="nv">}</span>
<span class="w">      </span><span class="ss">:text</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span></pre>
</div>

<p>
主体是一个 <code>Eventbox</code> 模块，子模块 <code>revealer</code> 。MPD 前端没有选择 mpc, 一是不灵活，它返回的状态信息不是 JSON 格式，难以解析；二个是写 SHELL 脚本对我来说真的很干。于是用 python-mpd2 去交互，脚本 <code>scripts/music</code>:
</p>

<div class="org-src-container">
<pre class="python"><span class="ch">#!/usr/bin/elvish</span>

<span class="n">use</span> <span class="nb">str</span>

<span class="n">fn</span> <span class="n">mpc_status</span> <span class="p">{</span>

  <span class="n">var</span> <span class="n">output</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">&amp;</span><span class="n">title</span><span class="o">=</span><span class="p">(</span><span class="n">mpc</span><span class="o">-</span><span class="n">unix</span> <span class="o">-</span><span class="n">f</span> <span class="s1">&#39;%title%&#39;</span> <span class="n">current</span><span class="p">)</span>
    <span class="o">&amp;</span><span class="n">artist</span><span class="o">=</span><span class="p">(</span><span class="n">mpc</span><span class="o">-</span><span class="n">unix</span> <span class="o">-</span><span class="n">f</span> <span class="s1">&#39;</span><span class="si">%a</span><span class="s1">rtist%&#39;</span> <span class="n">current</span><span class="p">)</span>
    <span class="o">&amp;</span><span class="n">state</span><span class="o">=</span><span class="p">(</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">:</span><span class="n">contains</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-</span><span class="n">unix</span> <span class="o">|</span> <span class="n">slurp</span><span class="p">)</span> <span class="s2">&quot;[playing]&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">put</span> <span class="p">(</span><span class="n">num</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">put</span> <span class="p">(</span><span class="n">num</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">]</span>
  <span class="n">put</span> <span class="err">$</span><span class="n">output</span> <span class="o">|</span> <span class="n">to</span><span class="o">-</span><span class="n">json</span>

<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">eq</span> <span class="err">$</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="err">$</span><span class="n">true</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">pgrep</span> <span class="o">-</span><span class="n">x</span> <span class="n">mpd</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
      <span class="n">mpc_status</span>
      <span class="n">mpc</span><span class="o">-</span><span class="n">unix</span> <span class="n">idleloop</span> <span class="o">|</span> <span class="n">each</span> <span class="p">{</span>
        <span class="o">|</span><span class="n">line</span><span class="o">|</span>
        <span class="n">mpc_status</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="n">e</span> <span class="p">{</span>
      <span class="n">sleep</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">elif</span> <span class="p">(</span><span class="n">eq</span> <span class="err">$</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="s2">&quot;gui&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">emacs</span> <span class="o">-</span><span class="n">f</span> <span class="n">simple</span><span class="o">-</span><span class="n">mpc</span> <span class="o">--</span><span class="n">name</span> <span class="n">SIMPLEMPC</span> <span class="o">&amp;</span>
<span class="p">}</span> <span class="k">elif</span> <span class="p">(</span><span class="n">eq</span> <span class="err">$</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="s2">&quot;up&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">mpc</span><span class="o">-</span><span class="n">unix</span> <span class="n">prev</span> <span class="o">-</span><span class="n">q</span>
<span class="p">}</span> <span class="k">elif</span> <span class="p">(</span><span class="n">eq</span> <span class="err">$</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="s2">&quot;down&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">mpc</span><span class="o">-</span><span class="n">unix</span> <span class="nb">next</span> <span class="o">-</span><span class="n">q</span>
<span class="p">}</span> <span class="k">elif</span> <span class="p">(</span><span class="n">eq</span> <span class="err">$</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="s2">&quot;toggle&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">mpc</span><span class="o">-</span><span class="n">unix</span> <span class="n">toggle</span>
<span class="p">}</span></pre>
</div>

<p>
定义了四个动作：
</p>
<ul class="org-ul">
<li>up/down: 上一首和下一首</li>
<li>toggle: 我没找到 python-mpd2 的 toggle, 于是写一个判断，如果正在播放则暂停，否则播放（不过是暂停还是停止）</li>
<li>state: 用 idle 去监听事件，当事件变化时触发，并返回 <code>get_status</code> 获得的状态：歌曲名、歌手，以及播放状态（1 是正在播放，0 反之）</li>
</ul>

<p>
外面再套一层 while 循环是防止 mpd 连接的问题出现。
</p>

<p>
eww 这边 <code>revealer</code>, 然后加一个点击事件，用 Emacs 的包 <a href="https://github.com/jorenvo/simple-mpc" target="_blank">simple-mpc</a> 来做 GUI 前端。
</p>

<p>
效果展示：
</p>


<figure id="org64b3716">
<a href="/assets/0e9146a3dfa7c7332571b1f0ad5a9c1a.gif" target="_blank" target="_blank"><img src="/assets/0e9146a3dfa7c7332571b1f0ad5a9c1a.gif" alt="0e9146a3dfa7c7332571b1f0ad5a9c1a.gif"></a>

<figcaption>悬停展示信息，点击播放，鼠标滚轮下一首，再点击暂停</figcaption>
</figure>
</div>
</div>

<div id="outline-container-org81050e5" class="outline-3">
<h3 id="org81050e5">电池状态</h3>
<div class="outline-text-3" id="text-org81050e5">
<p>
电池状态模块 <code>~/.config/eww/modules/power.yuck</code>
</p>

<div class="org-src-container">
<pre class="lisp"><span class="p">(</span><span class="nv">defpoll</span><span class="w"> </span><span class="nv">power-status</span><span class="w"> </span><span class="ss">:interval</span><span class="w"> </span><span class="s">&quot;5s&quot;</span>
<span class="w">  </span><span class="ss">:initial</span><span class="w"> </span><span class="ss">&#39;{</span><span class="s">&quot;linking&quot;</span><span class="err">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span><span class="o">,</span><span class="w"> </span><span class="s">&quot;battery&quot;</span><span class="err">:</span><span class="w"> </span><span class="nv">[{</span><span class="s">&quot;name&quot;</span><span class="err">:</span><span class="w"> </span><span class="s">&quot;BAT0&quot;</span><span class="o">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="err">:</span><span class="w"> </span><span class="nv">0},</span><span class="w"> </span><span class="nv">{</span><span class="s">&quot;name&quot;</span><span class="err">:</span><span class="w"> </span><span class="s">&quot;BAT1&quot;</span><span class="o">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="err">:</span><span class="w"> </span><span class="nv">0}],</span><span class="w"> </span><span class="s">&quot;aver&quot;</span><span class="err">:</span><span class="w"> </span><span class="nv">0}</span><span class="o">&#39;</span>
<span class="w">  </span><span class="s">&quot;scripts/power&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">show-power</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">power</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">   </span><span class="ss">:onhover</span><span class="w"> </span><span class="s">&quot;eww update show-power=true&quot;</span><span class="w"> 		</span>
<span class="w">   </span><span class="ss">:onhoverlost</span><span class="w"> </span><span class="s">&quot;eww update show-power=false&quot;</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;power&quot;</span>
<span class="w">   </span><span class="ss">:tooltip</span><span class="w"> </span><span class="ss">&#39;${power-status[</span><span class="s">&quot;aver&quot;</span><span class="nv">]}%</span><span class="o">&#39;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">box</span>
<span class="w">    </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="nv">false</span>
<span class="w">    </span><span class="p">(</span><span class="nv">revealer</span>
<span class="w">     </span><span class="ss">:transition</span><span class="w"> </span><span class="s">&quot;slideleft&quot;</span>
<span class="w">     </span><span class="ss">:reveal</span><span class="w"> </span><span class="nv">{show-power}</span>
<span class="w">     </span><span class="ss">:duration</span><span class="w"> </span><span class="s">&quot;400ms&quot;</span>
<span class="w">     </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;items&quot;</span>
<span class="w">     </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">      </span><span class="ss">:tooltip</span><span class="w"> </span><span class="ss">&#39;${power-status[</span><span class="s">&quot;aver&quot;</span><span class="nv">]}</span><span class="o">&#39;</span>
<span class="w">      </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;item&quot;</span>
<span class="w">      </span><span class="p">(</span><span class="nv">progress</span>
<span class="w">       </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;progress&quot;</span>
<span class="w">       </span><span class="ss">:value</span><span class="w"> </span><span class="nv">{power-status[</span><span class="s">&quot;aver&quot;</span><span class="nv">]}</span>
<span class="w">       </span><span class="ss">:orientation</span><span class="w"> </span><span class="s">&quot;h&quot;</span>
<span class="w">       </span><span class="ss">:flipped</span><span class="w"> </span><span class="nv">true</span>
<span class="w">       </span><span class="ss">:width</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">box</span>
<span class="w">     </span><span class="ss">:class</span><span class="w"> </span><span class="nv">{power-status[</span><span class="s">&quot;aver&quot;</span><span class="nv">]</span><span class="w"> </span><span class="nb">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">?</span><span class="w"> </span><span class="s">&quot;critical-icon&quot;</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="s">&quot;icon&quot;</span><span class="nv">}</span>
<span class="w">     </span><span class="ss">:width</span><span class="w"> </span><span class="mi">24</span>
<span class="w">     </span><span class="ss">:height</span><span class="w"> </span><span class="mi">24</span>
<span class="w">     </span><span class="nv">{power-status[</span><span class="s">&quot;linking&quot;</span><span class="nv">]</span><span class="w"> </span><span class="nv">==</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="nv">?</span>
<span class="w">       </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="err">:</span>
<span class="w">       </span><span class="nv">power-status[</span><span class="s">&quot;aver&quot;</span><span class="nv">]</span><span class="w"> </span><span class="nb">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">?</span>
<span class="w">         </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="err">:</span>
<span class="w">         </span><span class="nv">power-status[</span><span class="s">&quot;aver&quot;</span><span class="nv">]</span><span class="w"> </span><span class="nb">&lt;=</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="nv">?</span>
<span class="w">           </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="err">:</span>
<span class="w">           </span><span class="nv">power-status[</span><span class="s">&quot;aver&quot;</span><span class="nv">]</span><span class="w"> </span><span class="nb">&lt;=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="nv">?</span>
<span class="w">             </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="err">:</span>
<span class="w">             </span><span class="nv">power-status[</span><span class="s">&quot;aver&quot;</span><span class="nv">]</span><span class="w"> </span><span class="nb">&lt;=</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="nv">?</span>
<span class="w">             </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="err">:</span>
<span class="w">             </span><span class="s">&quot; &quot;</span><span class="nv">}</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span></pre>
</div>

<p>
电池状态查询用的工具是 upower, 直接 pacman 安装即可。
</p>

<p>
脚本：
</p>

<div class="org-src-container">
<pre class="sh"><span class="ch">#!/usr/bin/elvish</span>

use<span class="w"> </span>re

var<span class="w"> </span><span class="nv">AC_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/org/freedesktop/UPower/devices/line_power_AC&quot;</span>
var<span class="w"> </span><span class="nv">BAT0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/org/freedesktop/UPower/devices/battery_BAT0&quot;</span>
var<span class="w"> </span><span class="nv">BAT1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/org/freedesktop/UPower/devices/battery_BAT1&quot;</span>

var<span class="w"> </span><span class="nv">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>re:replace<span class="w"> </span><span class="s2">&quot;(?s)^.*online:\\s+([a-z]*).*</span>$<span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">(</span>upower<span class="w"> </span>-i<span class="w"> </span><span class="nv">$AC_line</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>slurp<span class="o">))</span>
var<span class="w"> </span><span class="nv">value0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>re:replace<span class="w"> </span><span class="s2">&quot;(?s)^.*percentage:\\s+([0-9]*).*</span>$<span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">(</span>upower<span class="w"> </span>-i<span class="w"> </span><span class="nv">$BAT0</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>slurp<span class="o">))</span>
var<span class="w"> </span><span class="nv">value1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>re:replace<span class="w"> </span><span class="s2">&quot;(?s)^.*percentage:\\s+([0-9]*).*</span>$<span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">(</span>upower<span class="w"> </span>-i<span class="w"> </span><span class="nv">$BAT1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>slurp<span class="o">))</span>
var<span class="w"> </span><span class="nv">aver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>inexact-num<span class="w"> </span><span class="o">(</span>/<span class="w"> </span><span class="o">(</span>+<span class="w"> </span><span class="nv">$value0</span><span class="w"> </span><span class="nv">$value1</span><span class="o">)</span><span class="w"> </span><span class="m">2</span><span class="o">))</span>

var<span class="w"> </span><span class="nv">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">  </span><span class="p">&amp;</span><span class="nv">linking</span><span class="o">=</span><span class="nv">$link</span>
<span class="w">  </span><span class="p">&amp;</span><span class="nv">battery</span><span class="o">=[</span>
<span class="w">    </span><span class="o">[</span><span class="p">&amp;</span><span class="nv">name</span><span class="o">=</span>BAT0<span class="w"> </span><span class="p">&amp;</span><span class="nv">value</span><span class="o">=(</span>num<span class="w"> </span><span class="nv">$value0</span><span class="o">)]</span>
<span class="w">    </span><span class="o">[</span><span class="p">&amp;</span><span class="nv">name</span><span class="o">=</span>BAT1<span class="w"> </span><span class="p">&amp;</span><span class="nv">value</span><span class="o">=(</span>num<span class="w"> </span><span class="nv">$value1</span><span class="o">)]</span>
<span class="w">  </span><span class="o">]</span>
<span class="w">  </span><span class="p">&amp;</span><span class="nv">aver</span><span class="o">=</span><span class="nv">$aver</span>
<span class="o">]</span>
put<span class="w"> </span><span class="nv">$ret</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>to-json</pre>
</div>

<p>
主要获取两个状态，一是电源是否连线，二是当前电池电量。之前是两个电池都在 <code>revealer</code> 中展示，现在只展示平均值。
</p>

<p>
效果就是鼠标指向之后展示电源电量，拔线之后图标变成电池。懒得截图了。
</p>
</div>
</div>

<div id="outline-container-orgb8ea0ee" class="outline-3">
<h3 id="orgb8ea0ee">灯光</h3>
<div class="outline-text-3" id="text-orgb8ea0ee">
<p>
音量模块 <code>~/.config/eww/modules/backlight.yuck</code>
</p>

<div class="org-src-container">
<pre class="lisp"><span class="p">(</span><span class="nv">deflisten</span><span class="w"> </span><span class="nv">backlight-value</span><span class="w"> </span><span class="ss">:initial</span><span class="w"> </span><span class="s">&quot;2&quot;</span>
<span class="w">  </span><span class="s">&quot;scripts/backlight&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">show-backlight</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">backlight</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;backlight&quot;</span>
<span class="w">   </span><span class="ss">:onhover</span><span class="w"> </span><span class="s">&quot;eww update show-backlight=true&quot;</span><span class="w"> 		</span>
<span class="w">   </span><span class="ss">:onhoverlost</span><span class="w"> </span><span class="s">&quot;eww update show-backlight=false&quot;</span>
<span class="w">   </span><span class="ss">:tooltip</span><span class="w"> </span><span class="ss">&#39;${backlight-value</span><span class="w"> </span><span class="nb">*</span><span class="w"> </span><span class="nv">5}%</span><span class="o">&#39;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">box</span>
<span class="w">    </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="nv">false</span>
<span class="w">    </span><span class="p">(</span><span class="nv">revealer</span>
<span class="w">     </span><span class="ss">:transition</span><span class="w"> </span><span class="s">&quot;slideleft&quot;</span>
<span class="w">     </span><span class="ss">:reveal</span><span class="w"> </span><span class="nv">{show-backlight}</span>
<span class="w">     </span><span class="ss">:duration</span><span class="w"> </span><span class="s">&quot;400ms&quot;</span>
<span class="w">     </span><span class="p">(</span><span class="nv">scale</span>
<span class="w">      </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;bar&quot;</span>
<span class="w">      </span><span class="ss">:value</span><span class="w"> </span><span class="nv">{backlight-value}</span>
<span class="w">      </span><span class="ss">:min</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="ss">:max</span><span class="w"> </span><span class="mi">21</span>
<span class="w">      </span><span class="ss">:round-digits</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="ss">:width</span><span class="w"> </span><span class="mi">100</span>
<span class="w">      </span><span class="ss">:flipped</span><span class="w"> </span><span class="nv">true</span>
<span class="w">      </span><span class="ss">:onchange</span><span class="w"> </span><span class="s">&quot;scripts/backlight {}; eww update backlight-value={}&quot;</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">box</span>
<span class="w">     </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;icon&quot;</span>
<span class="w">     </span><span class="ss">:width</span><span class="w"> </span><span class="s">&quot;24&quot;</span>
<span class="w">     </span><span class="ss">:height</span><span class="w"> </span><span class="s">&quot;24&quot;</span>
<span class="w">     </span><span class="s">&quot;󰖨 &quot;</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span></pre>
</div>

<p>
音量模块用的工具是 <code>brightnessctl</code>.
</p>

<div class="org-src-container">
<pre class="sh"><span class="ch">#!/usr/bin/elvish</span>

use<span class="w"> </span>re
use<span class="w"> </span>str

fn<span class="w"> </span>volume_get_state<span class="w"> </span><span class="o">{</span>
<span class="w">  </span>var<span class="w"> </span><span class="nv">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="p">&amp;</span><span class="nv">mute</span><span class="o">=(</span>re:replace<span class="w"> </span><span class="s2">&quot;^Mute: ([a-z]+)</span>$<span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">(</span>pactl<span class="w"> </span>get-sink-mute<span class="w"> </span><span class="m">0</span><span class="o">))</span>
<span class="w">    </span><span class="p">&amp;</span><span class="nv">value</span><span class="o">=(</span>re:replace<span class="w"> </span><span class="s2">&quot;^.*\\s([0-9]+)%.*</span>$<span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">(</span>pactl<span class="w"> </span>get-sink-volume<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>read-line<span class="o">))</span>
<span class="w">  </span><span class="o">]</span>
<span class="w">  </span><span class="nb">set</span><span class="w"> </span>ret<span class="o">[</span>value<span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>/<span class="w"> </span><span class="nv">$ret</span><span class="o">[</span>value<span class="o">]</span><span class="w"> </span><span class="m">5</span><span class="o">)</span><span class="w"> </span>
<span class="w">  </span>put<span class="w"> </span><span class="nv">$ret</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>to-json
<span class="o">}</span>

<span class="k">if</span><span class="w"> </span><span class="o">(</span>!<span class="o">=</span><span class="w"> </span><span class="o">(</span>count<span class="w"> </span><span class="nv">$args</span><span class="o">)</span><span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>eq<span class="w"> </span><span class="nv">$args</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="s2">&quot;set&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>var<span class="w"> </span><span class="nv">vol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>*<span class="w"> </span><span class="nv">$args</span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="m">5</span><span class="o">)</span>
<span class="w">    </span>pactl<span class="w"> </span>set-sink-volume<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">$vol</span><span class="s2">&quot;%&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/dev/null
<span class="w">  </span><span class="o">}</span><span class="w"> </span><span class="k">elif</span><span class="w"> </span><span class="o">(</span>eq<span class="w"> </span><span class="nv">$args</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="s2">&quot;toggle&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>pactl<span class="w"> </span>set-sink-mute<span class="w"> </span><span class="m">0</span><span class="w"> </span>toggle<span class="w"> </span>&gt;&gt;<span class="w"> </span>/dev/null
<span class="w">  </span><span class="o">}</span>
<span class="o">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>volume_get_state
<span class="w">  </span>pactl<span class="w"> </span>subscribe<span class="w"> </span><span class="p">|</span><span class="w"> </span>each<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="p">|</span>line<span class="p">|</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>str:contains<span class="w"> </span><span class="nv">$line</span><span class="w"> </span><span class="s2">&quot;&#39;change&#39; on sink&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">      </span>volume_get_state
<span class="w">    </span><span class="o">}</span>

<span class="w">  </span><span class="o">}</span>
<span class="o">}</span></pre>
</div>
</div>
</div>

<div id="outline-container-org0422efc" class="outline-3">
<h3 id="org0422efc">音量模块</h3>
<div class="outline-text-3" id="text-org0422efc">
<p>
音量模块 <code>~/.config/eww/modules/volume.yuck</code>
</p>

<div class="org-src-container">
<pre class="lisp"><span class="p">(</span><span class="nv">deflisten</span><span class="w"> </span><span class="nv">volume-state</span>
<span class="w">  </span><span class="ss">:initial</span><span class="w"> </span><span class="ss">&#39;{</span><span class="s">&quot;mute&quot;</span><span class="err">:</span><span class="s">&quot;no&quot;</span><span class="o">,</span><span class="s">&quot;value&quot;</span><span class="ss">:0}</span><span class="o">&#39;</span>
<span class="w">  </span><span class="s">&quot;scripts/volume&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">show-volume</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">volume</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;volume&quot;</span>
<span class="w">   </span><span class="ss">:onhover</span><span class="w"> </span><span class="s">&quot;${EWW_CMD} update show-volume=true&quot;</span><span class="w"> 		</span>
<span class="w">   </span><span class="ss">:onhoverlost</span><span class="w"> </span><span class="s">&quot;${EWW_CMD} update show-volume=false&quot;</span>
<span class="w">   </span><span class="ss">:tooltip</span><span class="w"> </span><span class="ss">&#39;${volume-state[</span><span class="s">&quot;value&quot;</span><span class="nv">]</span><span class="w"> </span><span class="nb">*</span><span class="w"> </span><span class="nv">5}%</span><span class="o">&#39;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">box</span>
<span class="w">    </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="nv">false</span>
<span class="w">    </span><span class="p">(</span><span class="nv">revealer</span>
<span class="w">     </span><span class="ss">:transition</span><span class="w"> </span><span class="s">&quot;slideleft&quot;</span>
<span class="w">     </span><span class="ss">:reveal</span><span class="w"> </span><span class="nv">{show-volume}</span>
<span class="w">     </span><span class="ss">:duration</span><span class="w"> </span><span class="s">&quot;400ms&quot;</span>
<span class="w">     </span><span class="p">(</span><span class="nv">scale</span>
<span class="w">      </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;bar&quot;</span>
<span class="w">      </span><span class="ss">:value</span><span class="w"> </span><span class="nv">{volume-state[</span><span class="s">&quot;value&quot;</span><span class="nv">]}</span>
<span class="w">      </span><span class="ss">:min</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="ss">:max</span><span class="w"> </span><span class="mi">21</span>
<span class="w">      </span><span class="ss">:round-digits</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="ss">:width</span><span class="w"> </span><span class="mi">100</span>
<span class="w">      </span><span class="ss">:flipped</span><span class="w"> </span><span class="nv">true</span>
<span class="w">      </span><span class="ss">:onchange</span><span class="w"> </span><span class="s">&quot;scripts/volume set {}&quot;</span>
<span class="w">      </span><span class="ss">:timeout</span><span class="w"> </span><span class="s">&quot;5s&quot;</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">     </span><span class="ss">:class</span><span class="w"> </span><span class="nv">{volume-state[</span><span class="s">&quot;mute&quot;</span><span class="nv">]</span><span class="w"> </span><span class="nv">==</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="nv">?</span><span class="w"> </span><span class="ss">&#39;icon</span><span class="w"> </span><span class="nv">mute</span><span class="o">&#39;</span><span class="err">:</span><span class="w"> </span><span class="ss">&#39;icon&#39;}</span>
<span class="w">     </span><span class="ss">:onclick</span><span class="w"> </span><span class="s">&quot;scripts/volume toggle&quot;</span>
<span class="w">     </span><span class="ss">:cursor</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span>
<span class="w">     </span><span class="ss">:width</span><span class="w"> </span><span class="s">&quot;24&quot;</span>
<span class="w">     </span><span class="ss">:height</span><span class="w"> </span><span class="s">&quot;24&quot;</span>
<span class="w">     </span><span class="nv">{volume-state[</span><span class="s">&quot;mute&quot;</span><span class="nv">]</span><span class="w"> </span><span class="nv">==</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="nv">?</span><span class="w"> </span><span class="s">&quot;󰝟 &quot;</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="s">&quot;󰕾 &quot;</span><span class="nv">}</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span></pre>
</div>

<p>
音量模块用的工具是 <code>pactl</code>. 音量模块脚本 <code>scripts/volume</code>:
</p>

<div class="org-src-container">
<pre class="sh"><span class="ch">#!/usr/bin/elvish</span>

use<span class="w"> </span>re
use<span class="w"> </span>str

fn<span class="w"> </span>volume_get_state<span class="w"> </span><span class="o">{</span>
<span class="w">  </span>var<span class="w"> </span><span class="nv">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="p">&amp;</span><span class="nv">mute</span><span class="o">=(</span>re:replace<span class="w"> </span><span class="s2">&quot;^Mute: ([a-z]+)</span>$<span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">(</span>pactl<span class="w"> </span>get-sink-mute<span class="w"> </span><span class="m">0</span><span class="o">))</span>
<span class="w">    </span><span class="p">&amp;</span><span class="nv">value</span><span class="o">=(</span>re:replace<span class="w"> </span><span class="s2">&quot;^.*\\s([0-9]+)%.*</span>$<span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">(</span>pactl<span class="w"> </span>get-sink-volume<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>read-line<span class="o">))</span>
<span class="w">  </span><span class="o">]</span>
<span class="w">  </span><span class="nb">set</span><span class="w"> </span>ret<span class="o">[</span>value<span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>/<span class="w"> </span><span class="nv">$ret</span><span class="o">[</span>value<span class="o">]</span><span class="w"> </span><span class="m">5</span><span class="o">)</span><span class="w"> </span>
<span class="w">  </span>put<span class="w"> </span><span class="nv">$ret</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>to-json
<span class="o">}</span>

<span class="k">if</span><span class="w"> </span><span class="o">(</span>!<span class="o">=</span><span class="w"> </span><span class="o">(</span>count<span class="w"> </span><span class="nv">$args</span><span class="o">)</span><span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>eq<span class="w"> </span><span class="nv">$args</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="s2">&quot;set&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>var<span class="w"> </span><span class="nv">vol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>*<span class="w"> </span><span class="nv">$args</span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="m">5</span><span class="o">)</span>
<span class="w">    </span>pactl<span class="w"> </span>set-sink-volume<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">$vol</span><span class="s2">&quot;%&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/dev/null
<span class="w">  </span><span class="o">}</span><span class="w"> </span><span class="k">elif</span><span class="w"> </span><span class="o">(</span>eq<span class="w"> </span><span class="nv">$args</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="s2">&quot;toggle&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>pactl<span class="w"> </span>set-sink-mute<span class="w"> </span><span class="m">0</span><span class="w"> </span>toggle<span class="w"> </span>&gt;&gt;<span class="w"> </span>/dev/null
<span class="w">  </span><span class="o">}</span>
<span class="o">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>volume_get_state
<span class="w">  </span>pactl<span class="w"> </span>subscribe<span class="w"> </span><span class="p">|</span><span class="w"> </span>each<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="p">|</span>line<span class="p">|</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>str:contains<span class="w"> </span><span class="nv">$line</span><span class="w"> </span><span class="s2">&quot;&#39;change&#39; on sink&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">      </span>volume_get_state
<span class="w">    </span><span class="o">}</span>

<span class="w">  </span><span class="o">}</span>
<span class="o">}</span></pre>
</div>

<p>
定义一个监听变量，用 <code>pactl subscribe</code> 去监听音量变化，返回给 eww.
</p>

<p>
音量信息获取通过 <code>pactl get-xxx</code> 并通过 sed 来取得想要的值。设置音量则是 <code>pactl set-sink-volume</code>.
</p>

<p>
注意到，我在 Scale 模块设置的最大值是要设置 20，但滑动到头会少 1，所以设置为 21. 为什么是 20 ？ EWW 的 Scale 模块用鼠标滚轮滚一下是<b>变动 1</b> ，如果想常规那样设置 0 到 100，每次滚轮滚 1 那得有多离谱。最大值设为 20 ，这样每次鼠标滚轮滚一次其实代表的是 5 。所以在配置中会看到乘 5 或除以 5 的操作。
</p>

<p>
效果展示：
</p>


<figure id="org5d3e230">
<a href="/assets/b458ba1868b8c5e545864f3bc11c6d82.gif" target="_blank" target="_blank"><img src="/assets/b458ba1868b8c5e545864f3bc11c6d82.gif" alt="b458ba1868b8c5e545864f3bc11c6d82.gif"></a>

</figure>

<p>
后续还需要设置一个组件，在音量变化的时候弹出显示当前音量，或者是让音量的 revealer 显示，不然键盘调音量都不知道调到多少。
</p>
</div>
</div>

<div id="outline-container-org89e533e" class="outline-3">
<h3 id="org89e533e">用户模块</h3>
<div class="outline-text-3" id="text-org89e533e">
<p>
其实我不知道用啥名字和图标比较好，这个模块是用来关机重启的。 <code>~/.config/eww/modules/user.yuck</code>
</p>

<div class="org-src-container">
<pre class="lisp"><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">show-user</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defwidget</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="nv">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">   </span><span class="ss">:onhover</span><span class="w"> </span><span class="s">&quot;${EWW_CMD} update show-user=true&quot;</span><span class="w"> 		</span>
<span class="w">   </span><span class="ss">:onhoverlost</span><span class="w"> </span><span class="s">&quot;${EWW_CMD} update show-user=false&quot;</span>
<span class="w">   </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
<span class="w">   </span><span class="p">(</span><span class="nv">box</span>
<span class="w">    </span><span class="ss">:space-evenly</span><span class="w"> </span><span class="s">&quot;false&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="nv">revealer</span>
<span class="w">     </span><span class="ss">:transition</span><span class="w"> </span><span class="s">&quot;slideleft&quot;</span>
<span class="w">     </span><span class="ss">:reveal</span><span class="w"> </span><span class="s">&quot;${show-user}&quot;</span>
<span class="w">     </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;box&quot;</span>
<span class="w">     </span><span class="ss">:duration</span><span class="w"> </span><span class="s">&quot;400ms&quot;</span>
<span class="w">     </span><span class="p">(</span><span class="nv">box</span>
<span class="w">      </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;item&quot;</span>
<span class="w">      </span><span class="ss">:spacing</span><span class="w"> </span><span class="mi">5</span>
<span class="w">      </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">       </span><span class="ss">:cursor</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span>
<span class="w">       </span><span class="ss">:onclick</span><span class="w"> </span><span class="s">&quot;systemctl poweroff&quot;</span>
<span class="w">       </span><span class="ss">:tooltip</span><span class="w"> </span><span class="s">&quot;power off&quot;</span>
<span class="w">       </span><span class="ss">:width</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
<span class="w">       </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;poweroff&quot;</span>
<span class="w">       </span><span class="ss">:height</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
<span class="w">       </span><span class="s">&quot; &quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">       </span><span class="ss">:cursor</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span>
<span class="w">       </span><span class="ss">:onclick</span><span class="w"> </span><span class="s">&quot;systemctl reboot&quot;</span>
<span class="w">       </span><span class="ss">:tooltip</span><span class="w"> </span><span class="s">&quot;reboot&quot;</span>
<span class="w">       </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;reboot&quot;</span>
<span class="w">       </span><span class="ss">:width</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
<span class="w">       </span><span class="ss">:height</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
<span class="w">       </span><span class="s">&quot; &quot;</span>
<span class="w">       </span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">       </span><span class="ss">:cursor</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span>
<span class="w">       </span><span class="ss">:onclick</span><span class="w"> </span><span class="s">&quot;systemctl suspendf&quot;</span>
<span class="w">       </span><span class="ss">:tooltip</span><span class="w"> </span><span class="s">&quot;lock&quot;</span>
<span class="w">       </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;lock&quot;</span>
<span class="w">       </span><span class="ss">:width</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
<span class="w">       </span><span class="ss">:height</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
<span class="w">       </span><span class="s">&quot; &quot;</span>
<span class="w">       </span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">       </span><span class="ss">:cursor</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span>
<span class="w">       </span><span class="ss">:onclick</span><span class="w"> </span><span class="s">&quot;systemctl suspend&quot;</span>
<span class="w">       </span><span class="ss">:tooltip</span><span class="w"> </span><span class="s">&quot;suspend&quot;</span>
<span class="w">       </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;suspend&quot;</span>
<span class="w">       </span><span class="ss">:width</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
<span class="w">       </span><span class="ss">:height</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
<span class="w">       </span><span class="s">&quot;󰤄 &quot;</span>
<span class="w">       </span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">       </span><span class="ss">:cursor</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span>
<span class="w">       </span><span class="ss">:onclick</span><span class="w"> </span><span class="s">&quot;loginctl terminate-user $USER&quot;</span>
<span class="w">       </span><span class="ss">:tooltip</span><span class="w"> </span><span class="s">&quot;log out&quot;</span>
<span class="w">       </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;logout&quot;</span>
<span class="w">       </span><span class="ss">:width</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
<span class="w">       </span><span class="ss">:height</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
<span class="w">       </span><span class="s">&quot; &quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nv">eventbox</span>
<span class="w">     </span><span class="ss">:class</span><span class="w"> </span><span class="s">&quot;icon&quot;</span>
<span class="w">     </span><span class="ss">:width</span><span class="w"> </span><span class="s">&quot;24&quot;</span>
<span class="w">     </span><span class="ss">:height</span><span class="w"> </span><span class="s">&quot;24&quot;</span>
<span class="w">     </span><span class="s">&quot; &quot;</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span></pre>
</div>

<p>
都是些系统相关命令，直接写到 <code>onclick</code> 上，最好是加个几秒延时。
</p>
</div>
</div>
</div>

<div id="outline-container-org3636e8f" class="outline-2">
<h2 id="org3636e8f">样式</h2>
<div class="outline-text-2" id="text-org3636e8f">
<p>
样式就是 gtk 的 scss. 通过组件给的 <code>class</code> 参数去选择。这个不是本文的重点，但我状态栏等 GUI 的设计，对于我等没有艺术训练的人来说真的挺困难，功能总能实现，但是样子吧，只能说看的过去，很有后端的风格。
</p>
</div>
</div>

<div id="outline-container-org23b9382" class="outline-2">
<h2 id="org23b9382">后记</h2>
<div class="outline-text-2" id="text-org23b9382">
<p>
这篇笔记老早就写了，当时折腾完 Hyprland 就做了记录。只是这几个月兜兜转转，现在才最终落笔。 EWW 神器属于是，资源占用低，动画流畅，配置写起来也很顺畅，调试会给出详细的日志。现在就等一手系统托盘，这个功能出来之后就完美了。
</p>
</div>
</div>
<div id="footnotes">
<hr>
<div class="text-footnotes" role="doc-endnotes">
<ol>
<li id="fn:1">
<p class="footpara">
<a href="https://hyprland.org/rices" target="_blank">Hyprland - A wayland compositor that doesn't sacrifice on its looks!</a>
<a href="#fnr:1.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
</div>
</div>
</div>
<div id="footer">
<center> The End </center></div>
</body>
</html>
