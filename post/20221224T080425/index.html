<!DOCTYPE html>
<html>
<head>
<title>Arch linux 下 clash cgproxy 实现全局代理（透明代理） - 手指骑士的病房</title>
<link rel="icon" href="/static/favicon.ico"><link href= "/static/style/style.css" rel="stylesheet" type="text/css" /></head>
<body>
<div class="header">
<div class="home-page">
<a href="/">手指骑士的病房</a></div><div class="nav">
<div class="nav item">
<a href="/tags">标签</a>
</div>
<div class="nav item">
<a href="/archive">归档</a>
</div>
<div class="nav item">
<a href="/about">关于</a>
</div>
<div class="nav item">
<a href="/emacs">Emacs</a>
</div>
</div>
</div>
<div class="main">
<div id="preamble" class="status"><link rel="stylesheet" href="/static/pygments/dracula.css"><div class="toc">
<h2 class="toc-title"> TOC </h2>
<nav id="TableOfContents">

<ul>
<li>
<a href="#org330ab2c"> 2022-12-12 更新 </a>
<ul>
<li>
<a href="#orgf573e33"> 终端 </a></li>
<li>
<a href="#org09a8bc7"> 浏览器 </a></li>
<li>
<a href="#org51058e2"> Emacs </a></li>
</ul>
</li>
<li>
<a href="#orgbf5a2f4"> 起因 </a></li>
<li>
<a href="#org8eee9ab"> 环境 </a></li>
<li>
<a href="#org885699f"> 工具安装 </a>
<ul>
<li>
<a href="#orgb5789a5"> Clash 安装 </a></li>
<li>
<a href="#org389a468"> cgproxy 安装 </a></li>
<li>
<a href="#orgf5d96a3"> Pyyaml 安装 </a></li>
</ul>
</li>
<li>
<a href="#org47528fc"> Clash 配置 </a>
<ul>
<li>
<a href="#org9bb5680"> Clash 配置文件 </a>
<ul>
<li>
<a href="#org05b55ef"> 2022-12-12 更新 </a></li>
</ul>
</li>
<li>
<a href="#orgbe365d0"> Clash 服务 </a>
<ul>
<li>
<a href="#orgd9b6819"> 脚本编写 </a></li>
<li>
<a href="#org2e166a9"> 流程介绍 </a></li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#org9fcd3e1"> cgproxy 配置 </a></li>
<li>
<a href="#org8bb4203"> Python 配置 </a></li>
<li>
<a href="#orgeb009ee"> 结语 </a></li>
</ul>
</nav>
</div>
<h1 class="post-title"> Arch linux 下 clash cgproxy 实现全局代理（透明代理） </h1>
<div class="post-date">2023-05-17</div>
<div class="taglist"><a href="/tag/archlinux"> #archlinux </a>
<a href="/tag/clash"> #clash </a>
<a href="/tag/proxy"> #proxy </a>
</div>
</div>
<div id="content">

<div id="outline-container-org330ab2c" class="outline-2">
<h2 id="org330ab2c">2022-12-12 更新</h2>
<div class="outline-text-2" id="text-org330ab2c">
<p>
DNS 污染，我解不开，没有相关的知识。最后决定不用全局代理了，为几个必要的、常用的应用单独设置即可。
</p>
</div>

<div id="outline-container-orgf573e33" class="outline-3">
<h3 id="orgf573e33">终端</h3>
<div class="outline-text-3" id="text-orgf573e33">
<p>
我用的终端是 <a href="https://www.zsh.org" target="_blank">zsh</a> ，配置环境变量 <code>~/.zshrc</code> 或 <code>/.zshenv</code>:
</p>

<div class="org-src-container">
<pre class="bash"> <span class="nb">export</span><span class="w"> </span><span class="nv">ALL_PROXY</span><span class="o">=</span><span class="s2">&quot;http://127.0.0.1:7890&quot;</span>
 </pre>
</div>
</div>
</div>

<div id="outline-container-org09a8bc7" class="outline-3">
<h3 id="org09a8bc7">浏览器</h3>
<div class="outline-text-3" id="text-org09a8bc7">
<p>
我用的是 <a href="https://vivaldi.com/" target="_blank">Vivaldi</a> ，基于 Chromium 内核的，因此只需要设置系统代理就好。
</p>
</div>
</div>

<div id="outline-container-org51058e2" class="outline-3">
<h3 id="org51058e2">Emacs</h3>
<div class="outline-text-3" id="text-org51058e2">
<p>
Emacs 用到的网络请求主要是 <a href="https://gnus.org" target="_blank">GNUS</a> 和一些自己用 <a href="https://github.com/tkf/emacs-request" target="_blank">emacs-request</a> 写的函数：
</p>

<div class="org-src-container">
<pre class="lisp"> <span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">url-proxy-services</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;http&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;127.0.0.1:7890&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="s">&quot;https&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;127.0.0.1:7890&quot;</span><span class="p">))</span>
<span class="w">      </span><span class="nv">request-curl-options</span>
<span class="w">      </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;-x&quot;</span><span class="w"> </span><span class="s">&quot;http://127.0.0.1:7890&quot;</span><span class="p">))</span>
 </pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbf5a2f4" class="outline-2">
<h2 id="orgbf5a2f4">起因</h2>
<div class="outline-text-2" id="text-orgbf5a2f4">
<p>
上次没主意把 <a href="https://www.v2ray.com" target="_blank">v2ray</a> 升到了 v5 版本，然后出了大问题。尝试回滚，把 v2ray 装回 4.4 ，然后报了错，连不上站点，日志看起来是服务器的问题，事实上我手机一直用着，所以估计 v2ray 是报废了。之前一直用 <a href="https://qv2ray.net" target="_blank">qv2ray</a> + <a href="https://github.com/springzfx/cgproxy" target="_blank">cgproxy</a> 做全局代理<sup>[<a id="fnr:1.1" class="footref" href="#fn:1">1</a>]</sup>，很方便，每个应用程序都会走代理，省去很多麻烦 &#x2013; 其实根本就没管过。现在用不了了就考虑折腾一下 clash ，GLaDOS 跟我说 clash 更简单，所以尝试一番。
</p>

<p>
网上很多教程是配置 <code>iptables</code> ，还考虑什么旁路路由。我实在是不懂，硬着头皮乱配置一通，结果大失败。正心灰意冷之际，突然看到：
</p>


<figure id="org481617a">
<a href="/assets/ec554c3ecc1255a56b799104caeba05a.png" target="_blank" target="_blank"><img src="/assets/ec554c3ecc1255a56b799104caeba05a.png" alt="ec554c3ecc1255a56b799104caeba05a.png"></a>

<figcaption>cgproxy 项目简介</figcaption>
</figure>


<figure id="org41a4035">
<a href="/assets/44a15e20e0bad435085963db1dc80c53.png" target="_blank" target="_blank"><img src="/assets/44a15e20e0bad435085963db1dc80c53.png" alt="44a15e20e0bad435085963db1dc80c53.png"></a>

<figcaption>Clash 项目简介</figcaption>
</figure>

<p>
也就是说，cgproxy是通过 Tproxy 把流量转给 qv2ray 的，而 clash 也支持 Tproxy 。我突然心生一计 ——<b>先睡觉</b>。
</p>
</div>
</div>

<div id="outline-container-org8eee9ab" class="outline-2">
<h2 id="org8eee9ab">环境</h2>
<div class="outline-text-2" id="text-org8eee9ab">
<p>
本次尝试基于 <code>Arch linux</code> ，对于其他系统，如果你要折腾可能要亲力亲为，我爱莫能助。
</p>

<p>
需要的工具有：
</p>
<ul class="org-ul">
<li><a href="https://github.com/Dreamacro/clash" target="_blank">clash</a></li>
<li><a href="https://github.com/springzfx/cgproxy" target="_blank">cgproxy</a></li>
<li><code>Python3.10</code>, 和一个第三方库 <code>pyyaml</code> 。 这个我是用来更新订阅的，至于大佬们用 <code>curl</code> + <code>sed</code> ，我只能是望尘莫及。</li>
</ul>
</div>
</div>

<div id="outline-container-org885699f" class="outline-2">
<h2 id="org885699f">工具安装</h2>
<div class="outline-text-2" id="text-org885699f">
</div>
<div id="outline-container-orgb5789a5" class="outline-3">
<h3 id="orgb5789a5">Clash 安装</h3>
<div class="outline-text-3" id="text-orgb5789a5">
<p>
Clash 的下载页面在<a href="https://github.com/Dreamacro/clash/releases/tag/v1.11.8" target="_blank">这里</a>
</p>
<div class="org-src-container">
<pre class="bash"> sudo<span class="w"> </span>pacman<span class="w"> </span>-S<span class="w"> </span>clash
 </pre>
</div>

<p>
安装成功
</p>
<div class="org-src-container">
<pre class="bash"> clash<span class="w"> </span>-v
#<span class="w"> </span>Clash<span class="w"> </span><span class="m">1</span>.11.8<span class="w"> </span>linux<span class="w"> </span>amd64<span class="w"> </span>with<span class="w"> </span>go1.19<span class="w"> </span>unknown<span class="w"> </span>time
 </pre>
</div>

<p>
然后去安装规则库<sup>[<a id="fnr:2.1" class="footref" href="#fn:2">2</a>]</sup>，地址在<a href="https://github.com/alecthw/mmdb_china_ip_list/blob/master/README_en.md#fixed-download-connection" target="_blank">这里</a>。下载 <code>Country.mmdb</code> ， <code>release分支（Daily）</code> ，然后复制到 <code>~/.config/clash</code> 下。如果目录不存在手动创建，这个就是后面用来<b>存配置</b>的地方。
</p>
</div>
</div>

<div id="outline-container-org389a468" class="outline-3">
<h3 id="org389a468">cgproxy 安装</h3>
<div class="outline-text-3" id="text-org389a468">
<p>
cgproxy 的下载页面在<a href="https://github.com/springzfx/cgproxy/releases/tag/v0.19" target="_blank">这里</a>
</p>
<div class="org-src-container">
<pre class="bash"> yay<span class="w"> </span>-S<span class="w"> </span>cgproxy
 </pre>
</div>

<p>
如果 <code>yay</code> 遇到网络问题，可以用<sup>[<a id="fnr:1.2" class="footref" href="#fn:1">1</a>]</sup>，这样得先安装 <code>wget</code> ：
</p>
<div class="org-src-container">
<pre class="bash"> wget<span class="w"> </span>https://archlinuxstudio.github.io/ArchLinuxTutorial/res/cgproxy-0.19-1-x86_64.pkg.tar.zst
sudo<span class="w"> </span>pacman<span class="w"> </span>-U<span class="w"> </span>cgproxy-0.19-1-x86_64.pkg.tar.zst
 </pre>
</div>

<p>
安装成功
</p>
<div class="org-src-container">
<pre class="bash"> cgproxy<span class="w"> </span>--help
#<span class="w"> </span>Run<span class="w"> </span>program<span class="w"> </span>with<span class="w"> </span>proxy
#<span class="w"> </span>Usage:<span class="w"> </span>cgproxy<span class="w"> </span><span class="o">[</span>--help<span class="o">]</span><span class="w"> </span><span class="o">[</span>--debug<span class="o">]</span><span class="w"> </span><span class="p">&amp;</span>lt<span class="p">;</span>CMD<span class="p">&amp;</span>gt<span class="p">;</span>
 </pre>
</div>
</div>
</div>

<div id="outline-container-orgf5d96a3" class="outline-3">
<h3 id="orgf5d96a3">Pyyaml 安装</h3>
<div class="outline-text-3" id="text-orgf5d96a3">
<p>
这个库用来解析 <code>yaml</code> 文件， clash 的配置文件就是 <code>yaml</code> 格式。
</p>

<p>
注意，因为最终这些流程要写成系统服务，到时候执行 <code>Python</code> 脚本会以 <code>root</code> 权限去执行，所以 <code>Python</code> 库的安装不能装在普通用户家目录，也就是要用 <code>root</code> 权限去安装。
</p>
<div class="org-src-container">
<pre class="bash"> sudo<span class="w"> </span>pip<span class="w"> </span>pyyaml
 </pre>
</div>

<p>
安装成功
</p>
<div class="org-src-container">
<pre class="nil"> # 用 root 权限执行 python
$ sudo python 
&amp;gt;&amp;gt; import yaml
&amp;gt;&amp;gt; yaml.__version__
&#39;6.0&#39;
 </pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org47528fc" class="outline-2">
<h2 id="org47528fc">Clash 配置</h2>
<div class="outline-text-2" id="text-org47528fc">
</div>
<div id="outline-container-org9bb5680" class="outline-3">
<h3 id="org9bb5680">Clash 配置文件</h3>
<div class="outline-text-3" id="text-org9bb5680">
<p>
clash 的使用：
</p>
<div class="org-src-container">
<pre class="bash"> clash<span class="w"> </span>-d<span class="w"> </span>~/.config/clash
 </pre>
</div>
<p>
<code>-d</code> 指定了用哪个目录来作为配置文件目录。
</p>

<p>
如果目录没建的话，它会自动生成，同时会去下载 <code>mmdb</code> 。因为在<a href="#orgb5789a5">Clash 安装</a>那里已经装过了，这里就会跳过下载 —— 如果你没装它就自动安装。
</p>

<p>
配置文件路径就是 <code>~/.config/clash/config.yaml</code> 。我用的是订阅，下载来文件就是一个配好了的 <code>cofnig.yaml</code> 。
</p>

<p>
我是写了另一个配置文件，通过 <code>Python</code> 来处理的，在<a href="#org8bb4203">Python 配置</a>这一节我会说到，这里我介绍一下那些配置。
</p>
<div class="org-src-container">
<pre class="yaml"> <span class="nt">tproxy-port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7893</span>
<span class="nt">dns</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">enhanced-mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fake-ip</span>
<span class="w">  </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0:53</span>
<span class="w">  </span><span class="nt">nameserver</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">119.29.29.29</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">114.114.114.114</span>
<span class="w">  </span><span class="nt">fallback</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://1.1.1.1/dns-query</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://8.8.8.8/dns-query</span>
 </pre>
</div>

<ul class="org-ul">
<li><code>tproxy-port</code> 顾名思义，它指定了 <code>tproxy</code> 的监听端口， <code>cgproxy</code> 获取应用流量之后通过这个端口发给 <code>clash</code> ，这个要和 cgrpxoy 的配置一致（见<a href="#org9fcd3e1">cgproxy 配置</a>）</li>
<li><code>dns.enable</code> 开启 dns 嗅探</li>
<li><code>dns.enhanced-mode</code> 有 <code>redir-host</code> 和 <code>fake-ip</code> 两种模式<sup>[<a id="fnr:3.1" class="footref" href="#fn:3">3</a>]</sup>
<ul class="org-ul">
<li><code>redir-host</code>: 传统的DNS转发模式，局域网根据规则查询DNS请求获取真实IP地址。</li>
<li><code>fake-ip</code>: 伪造 IP 模式，内部DNS查询得到的是伪造 IP 段的某个地址，局域网使用伪 IP 与 Clash 通信， Clash 会根据伪 IP 找到真实 IP 使用 SOCKS 代理进行通信。</li>
</ul></li>
<li><code>dns.listen</code> dns 监听地址，ip 就填 <code>0.0.0.0</code> ，端口填 <code>53</code> 会有冲突，下面会调。</li>
<li><code>dns.nameserver</code> dns 服务器</li>
<li><code>dns.fallback</code> 如果GEOIP非 CN 时使用的 dns 服务器<sup>[<a id="fnr:3.2" class="footref" href="#fn:3">3</a>]</sup></li>
</ul>

<p>
为了使 clash 能监听 dns 的 53 端口，要写改 <code>/etc/systemd/resolved.conf</code> 文件<sup>[<a id="fnr:4.1" class="footref" href="#fn:4">4</a>]</sup>：
</p>
<div class="org-src-container">
<pre class="shell"> <span class="nv">DNSStubListener</span><span class="o">=</span>no
 </pre>
</div>
</div>

<div id="outline-container-org05b55ef" class="outline-4">
<h4 id="org05b55ef">2022-12-12 更新</h4>
<div class="outline-text-4" id="text-org05b55ef">
<p>
在使用期间经历了一次 DNS 污染，去网上查了资料，需要把 dns 服务器的地址改成 TSL 或 TCP 请求 <sup>[<a id="fnr:5.1" class="footref" href="#fn:5">5</a>]</sup> ：
</p>
<div class="org-src-container">
<pre class="yaml"> <span class="nt">tproxy-port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7893</span>
<span class="nt">dns</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">enhanced-mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fake-ip</span>
<span class="w">  </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0:53</span>
<span class="w">  </span><span class="nt">nameserver</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;tls://dns.rubyfish.cn:853&#39;</span>
<span class="w">  </span><span class="nt">fallback</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;tls://1.1.1.1:853&#39;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;tcp://1.1.1.1:53&#39;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;tcp://208.67.222.222:443&#39;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;tls://dns.google&#39;</span>
 </pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbe365d0" class="outline-3">
<h3 id="orgbe365d0">Clash 服务</h3>
<div class="outline-text-3" id="text-orgbe365d0">
<p>
把 clash 作为系统服务，让它随系统启动而启动，同时自己设置守护进程，挂了自己重启<sup>[<a id="fnr:6.1" class="footref" href="#fn:6">6</a>]</sup><sup>, </sup><sup>[<a id="fnr:7.1" class="footref" href="#fn:7">7</a>]</sup>。
</p>
</div>

<div id="outline-container-orgd9b6819" class="outline-4">
<h4 id="orgd9b6819">脚本编写</h4>
<div class="outline-text-4" id="text-orgd9b6819">
<p>
创立目录 <code>etc/clash</code> ，写一个脚本 <code>clash.sh</code> ，这个脚本用于控制 clash 的启停。要把 <code>CONFIG_DIR</code> 改成你的路径：
</p>
<div class="org-src-container">
<pre class="bash"> #!/bin/bash
#<span class="w"> </span>配置文件目录
<span class="nv">CONFIG_DIR</span><span class="o">=</span>/home/<span class="p">&amp;</span>lt<span class="p">;</span>you<span class="w"> </span>user<span class="w"> </span>name<span class="p">&amp;</span>gt<span class="p">;</span>/.config/clash
update<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>#<span class="w"> </span>检查更新
<span class="w">    </span>python<span class="w"> </span>/etc/clash/update.py<span class="w"> </span><span class="si">${</span><span class="nv">CONFIG_DIR</span><span class="si">}</span>/env.yaml
<span class="o">}</span>
start<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>#<span class="w"> </span>开启<span class="w"> </span>IP<span class="w"> </span>转发
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;net.ipv4.ip_forward = 1&quot;</span><span class="w"> </span><span class="p">&amp;</span>gt<span class="p">;&amp;</span>gt<span class="p">;</span><span class="w"> </span>/etc/sysctl.conf<span class="w"> </span><span class="p">&amp;</span>amp<span class="p">;&amp;</span>amp<span class="p">;</span><span class="w"> </span>sysctl<span class="w"> </span>-p
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;net.ipv6.conf.all.forwarding = 1&quot;</span><span class="w"> </span><span class="p">&amp;</span>gt<span class="p">;&amp;</span>gt<span class="p">;</span><span class="w"> </span>/etc/sysctl.conf<span class="w"> </span><span class="p">&amp;</span>amp<span class="p">;&amp;</span>amp<span class="p">;</span><span class="w"> </span>sysctl<span class="w"> </span>-p
<span class="w">    </span>#<span class="w"> </span>启动<span class="w"> </span>cgproxy
<span class="w">    </span>systemctl<span class="w"> </span>start<span class="w"> </span>cgproxy.service
<span class="w">    </span>#<span class="w"> </span>启动<span class="w"> </span>Clash
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;starting Clash&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$$</span><span class="w"> </span><span class="p">&amp;</span>gt<span class="p">;</span><span class="w"> </span>/var/run/clash.pid
<span class="w">    </span>/usr/bin/clash<span class="w"> </span>-d<span class="w"> </span><span class="si">${</span><span class="nv">CONFIG_DIR</span><span class="si">}</span>
<span class="o">}</span>
stop<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>#<span class="w"> </span>关停<span class="w"> </span>cgproxy
<span class="w">    </span>systemctl<span class="w"> </span>stop<span class="w"> </span>cgproxy.service
<span class="w">    </span>#<span class="w"> </span>关停<span class="w"> </span>Clash
<span class="w">    </span><span class="nv">PID</span><span class="o">=</span><span class="sb">`</span>cat<span class="w"> </span>/var/run/clash.pid<span class="sb">`</span>
<span class="w">    </span><span class="nb">kill</span><span class="w"> </span>-9<span class="w"> </span><span class="si">${</span><span class="nv">PID</span><span class="si">}</span>
<span class="w">    </span>rm<span class="w"> </span>/var/run/clash.pid
<span class="w">    </span>#<span class="w"> </span>关闭<span class="w"> </span>IP<span class="w"> </span>转发
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;net.ipv4.ip_forward = 0&quot;</span><span class="w"> </span><span class="p">&amp;</span>gt<span class="p">;&amp;</span>gt<span class="p">;</span><span class="w"> </span>/etc/sysctl.conf<span class="w"> </span><span class="p">&amp;</span>amp<span class="p">;&amp;</span>amp<span class="p">;</span><span class="w"> </span>sysctl<span class="w"> </span>-p
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;net.ipv6.conf.all.forwarding = 0&quot;</span><span class="w"> </span><span class="p">&amp;</span>gt<span class="p">;&amp;</span>gt<span class="p">;</span><span class="w"> </span>/etc/sysctl.conf<span class="w"> </span><span class="p">&amp;</span>amp<span class="p">;&amp;</span>amp<span class="p">;</span><span class="w"> </span>sysctl<span class="w"> </span>-p
<span class="o">}</span>
status<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;TODO&quot;</span>
<span class="o">}</span>
<span class="k">case</span><span class="w"> </span><span class="nv">$1</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span>update<span class="o">)</span>
<span class="w">    </span>update
<span class="w">    </span><span class="p">;;</span>
<span class="w">    </span>start<span class="o">)</span>
<span class="w">    </span>start
<span class="w">    </span><span class="p">;;</span>
<span class="w">    </span>stop<span class="o">)</span>
<span class="w">    </span>stop
<span class="w">    </span><span class="p">;;</span>
<span class="w">    </span>status<span class="o">)</span>
<span class="w">    </span>status
<span class="w">    </span><span class="p">;;</span>
<span class="w">    </span>*<span class="o">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$0</span><span class="s2"> update | start | stop | status &quot;</span><span class="w"> </span>
<span class="w">    </span><span class="p">;;</span>
<span class="k">esac</span>
 </pre>
</div>

<p>
写服务脚本 <code>/etc/systemd/system/clash.service</code> ：
</p>
<div class="org-src-container">
<pre class="bash"> <span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Clash<span class="w"> </span>Service
<span class="nv">Requires</span><span class="o">=</span>network-online.target
<span class="nv">After</span><span class="o">=</span>network.target<span class="w"> </span>network-online.target
<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">ExecStartPre</span><span class="o">=</span>/etc/clash/clash.sh<span class="w"> </span>update
<span class="nv">ExecStart</span><span class="o">=</span>/etc/clash/clash.sh<span class="w"> </span>start
<span class="nv">ExecStop</span><span class="o">=</span>/etc/clash/clash.sh<span class="w"> </span>stop
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">RestartPreventExitStatus</span><span class="o">=</span><span class="m">23</span>
<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
 </pre>
</div>

<p>
更新服务：
</p>
<div class="org-src-container">
<pre class="bash"> systemctl<span class="w"> </span>daemon-reload<span class="w"> </span>#<span class="w"> </span>刷新服务
systemctl<span class="w"> </span>start<span class="w"> </span>clash.service<span class="w"> </span>#<span class="w"> </span>启动服务，目前还不能启动
systemctl<span class="w"> </span>enbale<span class="w"> </span>clash.service<span class="w"> </span>#<span class="w"> </span>服务开机自启动
 </pre>
</div>
</div>
</div>

<div id="outline-container-org2e166a9" class="outline-4">
<h4 id="org2e166a9">流程介绍</h4>
<div class="outline-text-4" id="text-org2e166a9">
</div>
<ul class="org-ul">
<li><a id="orgd937cd8"></a>预处理<br>
<div class="outline-text-5" id="text-orgd937cd8">
<p>
<code>ExecStartPre</code> 调用控制脚本的 <code>update</code> ，在服务正式启动前作处理。控制脚本的 <code>update</code> 其实就是执行了一个 Python 脚本，用来更新订阅（详见 <a href="#org8bb4203">Python 配置</a>）。
</p>
</div>
</li>

<li><a id="org7b87fc3"></a>启动<br>
<div class="outline-text-5" id="text-org7b87fc3">
<p>
<code>ExecStart</code> 调用控制脚本的 <code>start</code> 。
</p>
<ol class="org-ol">
<li>把 <code>1</code> 写到 <code>ip_forward</code> ，表示要开启 IP 转发。</li>
<li>启动 cgproxy 服务</li>
<li>记录当前 clash 服务的 PID ，用于停止服务</li>
<li>开启 clash ，指定目录</li>
</ol>
</div>
</li>

<li><a id="orgc30749f"></a>停止<br>
<div class="outline-text-5" id="text-orgc30749f">
<p>
<code>ExecStop</code> 调用控制脚本的 <code>stop</code> 。
</p>
<ol class="org-ol">
<li>停止 cgproxy 服务</li>
<li>根据启动时记录的 PID 去关闭 clash 进程</li>
<li>把 <code>1</code> 写到 <code>ip_forward</code> ，停止 IP 转发</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9fcd3e1" class="outline-2">
<h2 id="org9fcd3e1">cgproxy 配置</h2>
<div class="outline-text-2" id="text-org9fcd3e1">
<p>
配置文件位于 <code>/etc/cgproxy/config.json</code>
</p>
<div class="org-src-container">
<pre class="json"> <span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;comment&quot;</span><span class="p">:</span><span class="s2">&quot;For usage, see https://github.com/springzfx/cgproxy&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;port&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">7893</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;program_noproxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;clash&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;program_proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">    </span><span class="nt">&quot;cgroup_noproxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/system.slice/clash.service&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;cgroup_proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;enable_gateway&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;enable_dns&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;enable_udp&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;enable_tcp&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;enable_ipv4&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;enable_ipv6&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;table&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10007</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;fwmark&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">39283</span>
<span class="p">}</span>
 </pre>
</div>
<p>
各个选项<sup>[<a id="fnr:8.1" class="footref" href="#fn:8">8</a>]</sup>：
</p>
<ul class="org-ul">
<li><code>port</code> Tproxy 的端口，就是 clash 配置文件里面指定的 <code>tproxy_port</code></li>
<li><code>program_noproxy</code> 不走代理的程序，把 <code>clash</code> 排除，不然会流量循环。像我的音乐软件 <code>listen1</code> 就可以加到里面，因所有流量都是国内的，用代理容易出现网络问题</li>
<li><code>program_proxy</code> 走代理的程序，这里留空，在后面程序组那里配置了</li>
<li><code>cgroup_noproxy</code> 不在代理的程序组</li>
<li><code>cgroup_proxy</code> 走代理的程序组， <code>/</code> 表示全部</li>
</ul>
<p>
剩下的就不介绍了，可以参考官网。
</p>

<p>
到这里，你可以把服务脚本里边的 <code>ExecStartPre=/etc/clash/clash.sh update</code> 先注释掉。然后更新服务，启动 <code>clash</code> ，应该就可以使用了， <code>curl https://google.com</code> 测试一下。
</p>
</div>
</div>

<div id="outline-container-org8bb4203" class="outline-2">
<h2 id="org8bb4203">Python 配置</h2>
<div class="outline-text-2" id="text-org8bb4203">
<p>
这部分是用来更新订阅的。
</p>

<p>
先写一个 py 脚本 <code>/etc/clash/update.py</code> <sup>[<a id="fnr:9.1" class="footref" href="#fn:9">9</a>]</sup><sup>, </sup><sup>[<a id="fnr:10.1" class="footref" href="#fn:10">10</a>]</sup><sup>, </sup><sup>[<a id="fnr:11.1" class="footref" href="#fn:11">11</a>]</sup>：
</p>
<div class="org-src-container">
<pre class="python"> <span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">http.client</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="k">def</span> <span class="nf">check_update</span><span class="p">(</span><span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">update_file</span> <span class="o">=</span> <span class="s2">&quot;/etc/clash/.lastupdate&quot;</span>
    <span class="n">cur_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">need_update</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">update_file</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">update_file</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">readable</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">last_update</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1"># 非空文件，且超过更新间隔</span>
        <span class="k">if</span> <span class="n">cur_time</span> <span class="o">-</span> <span class="n">last_update</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="n">interval</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">need_update</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 空文件，新建</span>
        <span class="n">last_update</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">need_update</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">need_update</span>
<span class="k">def</span> <span class="nf">read_env</span><span class="p">(</span><span class="n">env_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
<span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="n">purl</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">doamin</span> <span class="o">=</span> <span class="n">purl</span><span class="o">.</span><span class="n">netloc</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">purl</span><span class="o">.</span><span class="n">path</span>
    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">HTTPSConnection</span><span class="p">(</span><span class="n">doamin</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File downloaded.&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span>
<span class="k">def</span> <span class="nf">write_and_update_to_file</span><span class="p">(</span><span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">env_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parsing file&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
    <span class="c1"># TPORXY-PORT</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tproxy-port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_data</span><span class="p">[</span><span class="s2">&quot;tproxy_port&quot;</span><span class="p">]</span>
    <span class="c1"># DNS</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dns&quot;</span><span class="p">][</span><span class="s2">&quot;enable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dns&quot;</span><span class="p">][</span><span class="s2">&quot;listen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0.0.0.0:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">env_data</span><span class="p">[</span><span class="s2">&quot;dns_port&quot;</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dns&quot;</span><span class="p">][</span><span class="s2">&quot;nameserver&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_data</span><span class="p">[</span><span class="s2">&quot;nameserver&quot;</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dns&quot;</span><span class="p">][</span><span class="s2">&quot;fallback&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">env_data</span><span class="p">[</span><span class="s2">&quot;fallback&quot;</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dns&quot;</span><span class="p">][</span><span class="s2">&quot;enhanced-mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;fake-ip&quot;</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">env_data</span><span class="p">[</span><span class="s2">&quot;clash_config&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving file to file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">save_path</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Update done&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">env_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">env_data</span> <span class="o">=</span> <span class="n">read_env</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check_update</span><span class="p">(</span><span class="n">env_data</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating&quot;</span><span class="p">)</span>
        <span class="n">write_and_update_to_file</span><span class="p">(</span>
            <span class="n">download_file</span><span class="p">(</span><span class="n">env_data</span><span class="p">[</span><span class="s2">&quot;clash_url&quot;</span><span class="p">]),</span>
            <span class="n">env_data</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Donnot update&quot;</span><span class="p">)</span>
 </pre>
</div>

<p>
配置文件 <code>~/.config/clash/env.yaml</code> ：
</p>
<div class="org-src-container">
<pre class="yaml"> <span class="c1"># TPROXY 端口</span>
<span class="nt">tproxy_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7893</span>
<span class="c1"># DNS 监听端口</span>
<span class="nt">dns_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">53</span>
<span class="c1"># 订阅地址，一个 yaml 文件</span>
<span class="nt">clash_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://xxx/yyy.yaml</span>
<span class="c1"># 订阅文件路径</span>
<span class="nt">clash_config</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/&amp;lt;your user name&amp;gt;/.config/clash/config.yaml</span>
<span class="c1"># 更新间隔（单位：天）</span>
<span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7</span>
<span class="c1"># 内 DNS 服务器</span>
<span class="nt">nameserver</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">119.29.29.29</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">114.114.114.114</span>
<span class="c1"># 外 DNS 服务器</span>
<span class="nt">fallback</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://1.1.1.1/dns-query</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://8.8.8.8/dns-query</span>
 </pre>
</div>

<p>
测试： <code>sudo python /etc/clash/update.py ~/.config/clash/env.yaml</code>
</p>
</div>
</div>

<div id="outline-container-orgeb009ee" class="outline-2">
<h2 id="orgeb009ee">结语</h2>
<div class="outline-text-2" id="text-orgeb009ee">
<p>
至此，clash + cgproxy 的透明代理就配置完成了。
</p>

<p>
如果想用 iptables 的话可以去参考文末给出的文章；想用 qv2ray + cgproxy 的话看参考的第一篇<sup>[<a id="fnr:1.3" class="footref" href="#fn:1">1</a>]</sup>。
</p>

<p>
希望对你有帮助
</p>
</div>
</div>
<div id="footnotes">
<hr>
<div class="text-footnotes" role="doc-endnotes">
<ol>
<li id="fn:1">
<p class="footpara">
<a href="https://archlinuxstudio.github.io/ArchLinuxTutorial/#/rookie/transparentProxy" target="_blank">全局代理</a>
<a href="#fnr:1.1" class="footnote-backref" role="doc-backlink">↩︎</a>
<a href="#fnr:1.2" class="footnote-backref" role="doc-backlink">↩︎</a>
<a href="#fnr:1.3" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:2">
<p class="footpara">
<a href="https://wiki.archlinux.org/title/Clash" target="_blank">Clash - ArchWiki</a>
<a href="#fnr:2.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:3">
<p class="footpara">
<a href="https://vlike.work/tech/trans_proxy.html" target="_blank">Clash透明代理实现方式总结 - 小V爱折腾</a>
<a href="#fnr:3.1" class="footnote-backref" role="doc-backlink">↩︎</a>
<a href="#fnr:3.2" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:4">
<p class="footpara">
<a href="https://www.right.com.cn/forum/thread-712362-1-1.html" target="_blank">N1 使用armbian系统设置clash作透明网关-斐讯无线路由器以及其它斐迅网络设备-恩山无线论坛</a>
<a href="#fnr:4.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:5">
<p class="footpara">
<a href="https://github.com/Fndroid/clash_for_windows_pkg/wiki/DNS%E6%B1%A1%E6%9F%93%E5%AF%B9Clash%EF%BC%88for-Windows%EF%BC%89%E7%9A%84%E5%BD%B1%E5%93%8D#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95" target="_blank">DNS污染对Clash（for Windows）的影响 · Fndroid/clash_for_windows_pkg Wiki · GitHub</a>
<a href="#fnr:5.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:6">
<p class="footpara">
<a href="https://xdays.me/Clash%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86/" target="_blank">Clash透明代理 | xdays</a>
<a href="#fnr:6.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:7">
<p class="footpara">
<a href="https://juejin.cn/post/6902058779236368392" target="_blank">Clash Linux 自启与更新订阅 - 掘金</a>
<a href="#fnr:7.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:8">
<p class="footpara">
<a href="https://github.com/springzfx/cgproxy#configuration" target="_blank">GitHub - springzfx/cgproxy: Transparent Proxy with cgroup v2。透明代理，配合v2ray/Qv2ray食用最佳</a>
<a href="#fnr:8.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:9">
<p class="footpara">
<a href="https://docs.python.org/zh-cn/3/library/http.client.html" target="_blank">http.client &#x2014; HTTP 协议客户端 — Python 3.10.7 文档</a>
<a href="#fnr:9.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:10">
<p class="footpara">
<a href="https://pyyaml.org/wiki/PyYAMLDocumentation" target="_blank">PyYAML Documentation</a>
<a href="#fnr:10.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:11">
<p class="footpara">
<a href="https://blog.csdn.net/qq_34495095/article/details/120905179" target="_blank">TypeError: load() missing 1 required positional argument: ‘Loader‘_one_wangtester的博客-CSDN博客</a>
<a href="#fnr:11.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
</div>
</div>
<div class="footer">
<center> The End </center></div>
</body>
</html>
