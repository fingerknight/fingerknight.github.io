<!DOCTYPE html>
<html>
<head>
<title>Emacs emms 媒体播放器 - 手指骑士的病房</title>
<link rel="icon" href="/static/favicon.ico"><link href= "/static/style/style.css" rel="stylesheet" type="text/css" /></head>
<body>
<div class="header">
<div class="home-page">
<a href="/">手指骑士的病房</a></div><div class="nav">
<div class="nav item">
<a href="/tags">标签</a>
</div>
<div class="nav item">
<a href="/archive">归档</a>
</div>
<div class="nav item">
<a href="/about">关于</a>
</div>
<div class="nav item">
<a href="/emacs">Emacs</a>
</div>
</div>
</div>
<div class="main">
<div id="preamble" class="status"><link rel="stylesheet" href="/static/pygments/dracula.css"><div class="toc">
<h2 class="toc-title"> TOC </h2>
<nav id="TableOfContents">

<ul>
<li>
<a href="#orgc6f908e"> 简介 </a></li>
<li>
<a href="#org106d947"> 安装 </a></li>
<li>
<a href="#org86702a1"> 快速配置 </a></li>
<li>
<a href="#orgad3cb01"> 自定义配置 </a>
<ul>
<li>
<a href="#org843aec7"> 后端选择 </a></li>
<li>
<a href="#org9eee65d"> 本地音乐路径 </a></li>
<li>
<a href="#org98013a2"> 本地音乐管理 </a></li>
<li>
<a href="#org45b210e"> 播放列表 </a>
<ul>
<li>
<a href="#org7f19043"> 播放列表配置 </a></li>
<li>
<a href="#org871d58d"> 播放列表操作 </a></li>
</ul>
</li>
<li>
<a href="#orga65508c"> 音量设置 </a></li>
<li>
<a href="#org9c1348f"> 歌词配置 </a></li>
<li>
<a href="#orge9bfab5"> 歌词来源 Lyrics-fetcher </a>
<ul>
<li>
<a href="#org1ca50a5"> 曲目元数据的添加和统一 </a></li>
<li>
<a href="#org7cb7bae"> 获取音乐元数据 </a></li>
<li>
<a href="#org1a037e8"> lyrics-fetcher 配置 </a></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
<h1 class="post-title"> Emacs emms 媒体播放器 </h1>
<div class="post-date">2023-05-17</div>
<div class="taglist"><a href="/tag/emacs"> #emacs </a>
<a href="/tag/emms"> #emms </a>
<a href="/tag/music"> #music </a>
</div>
</div>
<div id="content">

<div id="outline-container-orgc6f908e" class="outline-2">
<h2 id="orgc6f908e">简介</h2>
<div class="outline-text-2" id="text-orgc6f908e">
<p>
EMMS 全称 Emacs Multimedia System ，即 <b>Emacs 的多媒体系统</b>，用于在 Emacs 中展示和播放多媒体 <sup>[<a id="fnr:1.1" class="footref" href="#fn:1">1</a>]</sup> ，可以接入多种后端。我把它用来做音乐播放器，离入魔又近了一步。
</p>

<p>
EMMS 有非常详细的文档，用于参阅检索：《<a href="https://www.gnu.org/software/emms/manual/" target="_blank">The Emms Manual</a>》。
</p>
</div>
</div>

<div id="outline-container-org106d947" class="outline-2">
<h2 id="org106d947">安装</h2>
<div class="outline-text-2" id="text-org106d947">
<p>
可以直接用 <code>package.el</code> 的 <code>M-x package-install RET emms</code> 来安装，也可以下载到本地，通过 <code>(add-to-list 'load-path "/path/to/emms")</code> 来导入。
</p>

<p>
EMMS 的各个模块的功能拆成了许多小型的库，自定义程度高的话可通过一个个库的导入来灵活安排自己的配置。对于懒得折腾的用户， EMMS 提供了一步导入的配置。
</p>
</div>
</div>

<div id="outline-container-org86702a1" class="outline-2">
<h2 id="org86702a1">快速配置</h2>
<div class="outline-text-2" id="text-org86702a1">
<p>
EMMS 在库 <code>emms-setup</code> 给出了标准配置，可以通过它，直接使用标准配置。
</p>

<div class="org-src-container">
<pre class="lisp"> <span class="p">(</span><span class="nb">require</span><span class="w"> </span><span class="ss">&#39;emms-setup</span><span class="p">)</span>
<span class="p">(</span><span class="nv">emms-minimalistic</span><span class="p">)</span>
<span class="c1">;; or</span>
<span class="p">(</span><span class="nv">emms-all</span><span class="p">)</span>
<span class="c1">;; (emms-default-players)</span>
 </pre>
</div>

<ul class="org-ul">
<li><code>emms-minimalistic</code> 导入最小配置， <code>emms-all</code> 导入标准配置，二者选一个即可。</li>
<li><code>emms-default-player</code> 用于指明默认后端，最初的状态是没有指明的。 <code>emms-minimalistic</code> 和 <code>emms-all</code> 都调用了这个函数来初始化可选后端。</li>
</ul>
</div>
</div>

<div id="outline-container-orgad3cb01" class="outline-2">
<h2 id="orgad3cb01">自定义配置</h2>
<div class="outline-text-2" id="text-orgad3cb01">
<p>
我最后选择的是使用自定义的、模块化的配置，顺便学习一下 EMMS 的相关内容。
</p>
</div>

<div id="outline-container-org843aec7" class="outline-3">
<h3 id="org843aec7">后端选择</h3>
<div class="outline-text-3" id="text-org843aec7">
<p>
我的系统是 <a href="https://www.archlinux.org" target="_blank">Arch Linux</a> ，平时用的多媒体播放器是 <a href="https://mpv.io/" target="_blank">mpv</a> -&#x2013;&#x2014; 之前一直是用来播放视频的，它当然也能播放音乐。调用 EMMS 封装的 mpv 相关接口 <sup>[<a id="fnr:1.2" class="footref" href="#fn:1">1</a>]</sup> ：
</p>

<div class="org-src-container">
<pre class="lisp"> <span class="p">(</span><span class="nb">require</span><span class="w"> </span><span class="ss">&#39;emms-player-mpv</span><span class="p">)</span>
<span class="p">(</span><span class="nv">setq-default</span><span class="w"> </span><span class="nv">emms-player-list</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="nv">emms-player-mpv</span><span class="p">)</span>
<span class="w">              </span><span class="nv">emms-player-mpv-environment</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;PULSE_PROP_media.role=music&quot;</span><span class="p">)</span>
<span class="w">              </span><span class="nv">emms-player-mpv-parameters</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;--quiet&quot;</span><span class="w"> </span><span class="s">&quot;--really-quiet&quot;</span>
<span class="w">                                           </span><span class="s">&quot;--no-audio-display&quot;</span><span class="w"> </span><span class="s">&quot;--force-window=no&quot;</span><span class="w"> </span><span class="s">&quot;--vo=null&quot;</span><span class="p">))</span>
 </pre>
</div>

<p>
EMMS 支持的后端蛮多的，有 ogg123, mpg321, mpv, vlc 等，其余后端可以去参考手册的配置。
</p>
</div>
</div>

<div id="outline-container-org9eee65d" class="outline-3">
<h3 id="org9eee65d">本地音乐路径</h3>
<div class="outline-text-3" id="text-org9eee65d">
<p>
我转用本地音乐的原因就是<b>稳定</b>。之前尝试过的音乐软件有：
</p>
<ul class="org-ul">
<li><a href="https://github.com/qier222/YesPlayMusic" target="_blank">YesPlayMusic</a>, 高颜值的第三方网易云音乐客户端</li>
<li><a href="https://listen1.github.io/listen1/" target="_blank">Listen 1</a>, 整合多平台的音乐客户端</li>
<li><a href="https://github.com/feeluown/FeelUOwn" target="_blank">FeelUOwn</a>, Python 写的音乐客户端，比较生猛，把各个平台以及各种功能分为插件，折腾起来还不错</li>
</ul>

<p>
用的时候都是实时去各大音乐平台的接口请求，然后由于各种版权和会员的原因，很多音乐都无法播放或者返回的资源是一些听感不妥的 Live 版本，最终决定把音乐保存到本地。之前一直没落实是怕占空间，结果弄完发现才 2G 左右，所以归根结底还是<b>懒</b>……
</p>

<p>
既然我都用本地音乐了，为什么不用更简单的播放器呢？所以就尝试了使用 EMMS 的想法 &#x2013; 虽然配置以及下载花了一天的时间。
</p>

<p>
下面是关于本地音乐路径寻找的配置：
</p>
<div class="org-src-container">
<pre class="lisp"> <span class="p">(</span><span class="nb">require</span><span class="w"> </span><span class="ss">&#39;emms-source-file</span><span class="p">)</span>
<span class="p">(</span><span class="nv">setq-default</span><span class="w"> </span><span class="nv">emms-source-file-default-directory</span><span class="w"> </span><span class="s">&quot;~/Music/&quot;</span><span class="p">)</span>
 </pre>
</div>
<p>
有一个可选变量 <code>emms-source-file-directory-tree-function</code>, 这个变量指定了读取本地音乐的函数，它的默认值是 <code>emms-source-file-directory-tree-internal</code>, 有个备选 <code>emms-source-file-directory-tree-find</code> ，前者速度慢一些，后者速度更快，但是需要有 GNU 的 <code>find</code> 命令。
</p>

<p>
你也可以自定义这样一个函数，然后通过 <code>(setq-default emms-source-file-directory-tree-function your-func)</code> 配置。它传入两个参数，第一个是 <code>dir</code> ，即扫描的目录；第二个是 <code>regex</code> ，一个正则匹配样式，扫描出的文件需要符合才会纳入。你可以通过这个来自定义一些子目录或者屏蔽一些类型的文件。
</p>
</div>
</div>

<div id="outline-container-org98013a2" class="outline-3">
<h3 id="org98013a2">本地音乐管理</h3>
<div class="outline-text-3" id="text-org98013a2">
<p>
在默认目录 <code>emms-source-file-default-directory</code> 下，建立子目录，<b>每个子目录代表一张歌单</b>，每个歌单放入相应的本地音乐文件。我写了一个用于快速切换歌单的函数，依赖是 <a href="https://github.com/rejeep/f.el" target="_blank">f.el</a>, 一组与文件目录相关的 API ：
</p>
<div class="org-src-container">
<pre class="lisp"> <span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">emms-switch-playlist</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="err">&quot;</span><span class="nv">Switch</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">playlist,</span><span class="w"> </span><span class="nv">selected</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="o">`</span><span class="nv">emms-source-file-default-directory</span><span class="ss">&#39;,</span>
<span class="nb">and</span><span class="w"> </span><span class="nv">start</span><span class="w"> </span><span class="nv">playing</span><span class="w"> </span><span class="nv">immediately.</span><span class="err">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">interactive</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; 如果播放列表打开了，那么先关闭</span>
<span class="w">  </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nv">get-buffer</span><span class="w"> </span><span class="nv">emms-playlist-buffer-name</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">kill-buffer</span><span class="w"> </span><span class="nv">emms-playlist-buffer-name</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; 添加目录下的音乐文件到播放列表</span>
<span class="w">  </span><span class="p">(</span><span class="nv">emms-add-directory</span>
<span class="w">   </span><span class="p">(</span><span class="nv">f-expand</span>
<span class="w">    </span><span class="c1">;; 选择歌单</span>
<span class="w">    </span><span class="p">(</span><span class="nv">completing-read</span><span class="w"> </span><span class="s">&quot;Switch to: &quot;</span>
<span class="w">                     </span><span class="p">(</span><span class="nv">-map</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">f-base</span>
<span class="w">                           </span><span class="p">(</span><span class="nv">f-directories</span>
<span class="w">                            </span><span class="nv">emms-source-file-default-directory</span>
<span class="w">                            </span><span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">dir</span><span class="p">)</span>
<span class="w">                                </span><span class="c1">;; 这里排除了 lyrics 目录</span>
<span class="w">                                </span><span class="c1">;; 它是用来存放歌词文件的</span>
<span class="w">                                </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">member</span><span class="w"> </span><span class="p">(</span><span class="nv">f-base</span><span class="w"> </span><span class="nv">dir</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;lyrics&quot;</span><span class="p">)))))))</span>
<span class="w">    </span><span class="nv">emms-source-file-default-directory</span><span class="p">))</span>
<span class="w">  </span><span class="c1">;; 随机打乱播放列表</span>
<span class="w">  </span><span class="p">(</span><span class="nv">emms-shuffle</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; 重新打开播放列表的 buffer</span>
<span class="w">  </span><span class="p">(</span><span class="nv">switch-to-buffer-other-window</span><span class="w"> </span><span class="nv">emms-playlist-buffer-name</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; 开始播放</span>
<span class="w">  </span><span class="p">(</span><span class="nv">emms-playlist-mode-play-smart</span><span class="p">))</span>
 </pre>
</div>
</div>
</div>

<div id="outline-container-org45b210e" class="outline-3">
<h3 id="org45b210e">播放列表</h3>
<div class="outline-text-3" id="text-org45b210e">
</div>
<div id="outline-container-org7f19043" class="outline-4">
<h4 id="org7f19043">播放列表配置</h4>
<div class="outline-text-4" id="text-org7f19043">
<p>
播放列表<b>本质上就是一个 buffer</b> ，它把列表中的曲目打印到该 buffer 中，设置其为不可写并创生新的键盘映射。因此理论上说，可以打开多个播放列表，每个播放列表对应不同的歌单。不过似乎没什么必要。
</p>

<div class="org-src-container">
<pre class="lisp"> <span class="p">(</span><span class="nb">require</span><span class="w"> </span><span class="ss">&#39;emms-browser</span><span class="p">)</span>
<span class="p">(</span><span class="nv">setq-default</span>
<span class="w"> </span><span class="c1">;; 使当前播放的曲目居中于播放列表</span>
<span class="w"> </span><span class="nv">emms-playlist-mode-center-when-go</span><span class="w"> </span><span class="nc">t</span>
<span class="w"> </span><span class="c1">;; 播放列表的 buffer 的 mode</span>
<span class="w"> </span><span class="nv">emms-playlist-default-major-mode</span><span class="w"> </span><span class="ss">&#39;emms-playlist-mode</span>
<span class="w"> </span><span class="c1">;; 播放列表的 buffer 的名字</span>
<span class="w"> </span><span class="nv">emms-playlist-buffer-name</span><span class="w"> </span><span class="s">&quot;*Music*&quot;</span>
<span class="w"> </span><span class="nv">emms-track-description-function</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">track</span><span class="p">)</span>
<span class="w">                                   </span><span class="s">&quot;Function for describing an EMMS track&quot;</span>
<span class="w">                                   </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">name</span><span class="w"> </span><span class="p">(</span><span class="nv">f-base</span><span class="w"> </span><span class="p">(</span><span class="nv">emms-track-name</span><span class="w"> </span><span class="nv">track</span><span class="p">))))</span>
<span class="w">                                     </span><span class="p">(</span><span class="nv">seq-let</span><span class="w"> </span><span class="p">(</span><span class="nv">artist</span><span class="w"> </span><span class="nv">title</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">split-string</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="s">&quot; - &quot;</span><span class="p">)</span>
<span class="w">                                       </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="s">&quot;%s - %s&quot;</span><span class="w"> </span><span class="nv">title</span><span class="w"> </span><span class="nv">artist</span><span class="p">))))</span>
<span class="p">)</span>
 </pre>
</div>

<p>
<code>emms-track-description-function</code> 是曲目在播放列表中的显示函数，传入 <code>track</code> ，一个 ALIST, 装有歌曲的各种信息。它原本会把整个歌曲的本地路径输出，形如： <code>/home/user/Music/love/Linkin Park - In the End.mp3</code>, 过于抽象。再按照我的习惯把歌曲名字放前面，变成： <code>In the End - Linkin Park</code>.
</p>
</div>
</div>

<div id="outline-container-org871d58d" class="outline-4">
<h4 id="org871d58d">播放列表操作</h4>
<div class="outline-text-4" id="text-org871d58d">
<p>
这里列举了一部分，更多的参见手册：<a href="https://www.gnu.org/software/emms/manual/#Interactive-Playlists" target="_blank">https://www.gnu.org/software/emms/manual/#Interactive-Playlists</a>
</p>
<ul class="org-ul">
<li><code>n</code>, 播放下一首</li>
<li><code>p</code>, 播放上一首</li>
<li><code>RET</code>, 播放光标所在行的曲目</li>
<li><code>&gt;</code>, 快进 10s</li>
<li><code>&lt;</code>, 倒退 10s</li>
<li><code>d</code>, 将光标所在行的曲目移出播放列表</li>
<li><code>P</code>, 暂停播放</li>
<li><code>s</code>, 停止播放</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orga65508c" class="outline-3">
<h3 id="orga65508c">音量设置</h3>
<div class="outline-text-3" id="text-orga65508c">
<p>
配置：
</p>
<div class="org-src-container">
<pre class="lisp"> <span class="p">(</span><span class="nb">require</span><span class="w"> </span><span class="ss">&#39;emms-volume</span><span class="p">)</span>
<span class="p">(</span><span class="nv">global-set-key</span><span class="w"> </span><span class="p">(</span><span class="nv">kbd</span><span class="w"> </span><span class="s">&quot;C-c +&quot;</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;emms-volume-mode-plus</span><span class="p">)</span>
<span class="p">(</span><span class="nv">global-set-key</span><span class="w"> </span><span class="p">(</span><span class="nv">kbd</span><span class="w"> </span><span class="s">&quot;C-c -&quot;</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;emms-volume-mode-minus</span><span class="p">)</span>
<span class="c1">;; (setq-default emms-volume-change-amount 2</span>
<span class="w">              </span><span class="c1">;; emms-volume-mode-timeout 2)</span>
 </pre>
</div>

<p>
这两个全局快捷键用于调高、降低音量。可以通过 <code>C-c + + +</code> 来增加 3 次音量，或 <code>C-c - - - - -</code> 来降低 5 次音量。以增加音量举例，它的工作过程是：先使用 <code>C-c +</code> 即 <code>emms-volume-mode-plus</code> 来增加一次音量，并临时将当前的 mode 改为一个全新的 plus-mode ；在这个模式下， <code>+</code> 绑定到增加音量，按了之后便可以继续增加，同时刷新当前模式的生存时间；如果不再按 <code>+</code> ，过了生存时间后退出这个模式。
</p>

<p>
可以通过 <code>emms-volume-mode-timeout</code> 来指定 plus-mode 的生存时间，默认是 2s 。
</p>

<p>
此外，可以通过设置 <code>emms-volume-change-amount</code> 来表明每次增加或降低的音量的百分比，默认是 2 ，也就是每次调整 2% 。
</p>
</div>
</div>

<div id="outline-container-org9c1348f" class="outline-3">
<h3 id="org9c1348f">歌词配置</h3>
<div class="outline-text-3" id="text-org9c1348f">
<p>
基本配置：
</p>
<div class="org-src-container">
<pre class="lisp"> <span class="p">(</span><span class="nb">require</span><span class="w"> </span><span class="ss">&#39;emms-lyrics</span><span class="p">)</span>
<span class="p">(</span><span class="nv">setq-default</span>
<span class="w"> </span><span class="c1">;; 歌词文件存放路径</span>
<span class="w"> </span><span class="nv">emms-lyrics-dir</span><span class="w"> </span><span class="s">&quot;~/Music/lyrics&quot;</span>
<span class="w"> </span><span class="c1">;; 歌词显示在 minibuffer</span>
<span class="w"> </span><span class="nv">emms-lyrics-display-on-minibuffer</span><span class="w"> </span><span class="nc">t</span>
<span class="w"> </span><span class="c1">;; 歌词不滚动</span>
<span class="w"> </span><span class="nv">emms-lyrics-scroll-p</span><span class="w"> </span><span class="no">nil</span><span class="p">)</span>
<span class="c1">;; 开启歌词</span>
<span class="p">(</span><span class="nv">emms-lyrics</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
 </pre>
</div>

<p>
配置里面可以让歌词显示在 minibuffer 或状态栏，分别设置 <code>emms-lyrics-display-on-minibuffer</code> / <code>emms-lyrics-display-on-modeline</code> 为 <code>t</code> 或 <code>nil</code>.
</p>

<p>
我看配置可以配置一个单独的 buffer 来显示歌词，但是我没配成功，我选择了在 minibuffer 。
</p>

<p>
歌词文件与歌曲同名（后缀不同），放在 <code>emms-lyrics-dir</code> 目录下即可。
</p>
</div>
</div>

<div id="outline-container-orge9bfab5" class="outline-3">
<h3 id="orge9bfab5">歌词来源 Lyrics-fetcher</h3>
<div class="outline-text-3" id="text-orge9bfab5">
<p>
我用的是一个在论坛 <sup>[<a id="fnr:2.1" class="footref" href="#fn:2">2</a>]</sup> 里看到的前辈分享的包 <a href="https://github.com/SqrtMinusOne/lyrics-fetcher.el" target="_blank">lyrics-fetcher</a> 来获取歌词，目前他可以从 <a href="https://docs.genius.com/" target="_blank">genius.com</a> 或者网易云音乐获取，我用的是后者，它更容易找到中文歌的歌词。
</p>

<p>
安装过程参见其文档。
</p>

<p>
lyrics-fetcher 根据歌曲的元数据去查歌词，因此需要保证歌曲有元数据。 <b>lyrics-fetcher 并不可靠</b>
</p>
</div>

<div id="outline-container-org1ca50a5" class="outline-4">
<h4 id="org1ca50a5">曲目元数据的添加和统一</h4>
<div class="outline-text-4" id="text-org1ca50a5">
<p>
我用的是 Python 的 <a href="https://mutagen.readthedocs.io/" target="_blank">mutagen</a> 库来编辑曲目的元数据。
</p>
<div class="org-src-container">
<pre class="bash"> pip<span class="w"> </span>install<span class="w"> </span>mutagen
 </pre>
</div>

<p>
把歌曲的保存成 <code>歌手 - 歌名.mp3</code> 的格式，然后执行：
</p>
<div class="org-src-container">
<pre class="python"> <span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mutagen</span>
<span class="kn">from</span> <span class="nn">mutagen.id3</span> <span class="kn">import</span> <span class="n">ID3</span><span class="p">,</span> <span class="n">TIT2</span><span class="p">,</span> <span class="n">TALB</span><span class="p">,</span> <span class="n">TPE1</span><span class="p">,</span> <span class="n">TPE2</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/Music/&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">current_playlist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">pl</span><span class="p">)</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">current_playlist</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
        <span class="n">artist</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)</span>
        <span class="n">artist</span> <span class="o">=</span> <span class="n">artist</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_playlist</span><span class="p">,</span> <span class="n">each</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">audio</span> <span class="o">=</span> <span class="n">ID3</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">mutagen</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">old_filename</span><span class="p">)</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">add_tags</span><span class="p">()</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">audio</span> <span class="o">=</span> <span class="n">ID3</span><span class="p">(</span><span class="n">old_filename</span><span class="p">)</span>
        <span class="n">audio</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TALB</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">title</span><span class="p">))</span>
        <span class="n">audio</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TIT2</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">title</span><span class="p">))</span>
        <span class="n">audio</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TPE1</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">artist</span><span class="p">))</span>
        <span class="n">audio</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TPE2</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">artist</span><span class="p">))</span>
        <span class="n">audio</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
 </pre>
</div>

<p>
它会遍历本地音乐目录下的子目录，即歌单中的所有音乐文件，修改其元数据，主要改的是歌名和歌手。
</p>
</div>
</div>

<div id="outline-container-org7cb7bae" class="outline-4">
<h4 id="org7cb7bae">获取音乐元数据</h4>
<div class="outline-text-4" id="text-org7cb7bae">
<p>
EMMS 提供了几种工具的接口，参见：<a href="https://www.gnu.org/software/emms/manual/#Track-Information" target="_blank">https://www.gnu.org/software/emms/manual/#Track-Information</a>.
</p>

<p>
我选用的是 <a href="https://pypi.org/project/tinytag/" target="_blank">tinytag</a>. 安装： <code>pip install tinytag</code>.
</p>

<p>
然后是 Emacs 的配置。
</p>
<div class="org-src-container">
<pre class="lisp"> <span class="p">(</span><span class="nb">require</span><span class="w"> </span><span class="ss">&#39;emms-info-tinytag</span><span class="p">)</span>
<span class="p">(</span><span class="nv">setq-default</span>
<span class="w"> </span><span class="c1">;; 同步获取音乐元信息</span>
<span class="w"> </span><span class="nv">emms-info-asynchronously</span><span class="w"> </span><span class="kt">nil</span>
<span class="w"> </span><span class="c1">;; 音乐信息获取后端后端</span>
<span class="w"> </span><span class="nv">emms-info-functions</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="nv">emms-info-tinytag</span><span class="p">))</span>
<span class="c1">;; 获取音乐列表同时获取元信息</span>
<span class="p">(</span><span class="nv">add-to-list</span><span class="w"> </span><span class="ss">&#39;emms-track-initialize-functions</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">emms-info-initialize-track</span><span class="p">)</span>
 </pre>
</div>

<p>
注意的就是 <code>emms-info-asynchronously</code> 一定要是 <code>nil</code>, 也就是阻塞式读取元数据，否则 lyrics-fetcher 无法正常工作 -&#x2013;&#x2014; 异步读取， lyrics-fetcher 要获取歌词时歌曲的元数据信息还是空，所以会获取不到。
</p>

<p>
这样的话，在读取歌单时会小卡一下，取决歌单曲目数量。
</p>
</div>
</div>

<div id="outline-container-org1a037e8" class="outline-4">
<h4 id="org1a037e8">lyrics-fetcher 配置</h4>
<div class="outline-text-4" id="text-org1a037e8">
<p>
最后就是 lyrics-fetcher 的配置了。
</p>
<div class="org-src-container">
<pre class="lisp"> <span class="p">(</span><span class="nb">require</span><span class="w"> </span><span class="ss">&#39;lyrics-fetcher</span><span class="p">)</span>
<span class="c1">;; 歌词存放目录</span>
<span class="c1">;; (setq lyrics-fetcher-lyrics-folder &quot;~/Music/lyrics&quot;)</span>
<span class="c1">;; 歌词获取后端：网易云</span>
<span class="p">(</span><span class="nv">lyrics-fetcher-use-backend</span><span class="w"> </span><span class="ss">&#39;neteasecloud</span><span class="p">)</span>
<span class="c1">;; 播放歌曲前获取歌词</span>
<span class="p">(</span><span class="nv">add-hook</span><span class="w"> </span><span class="ss">&#39;emms-player-started-hook</span>
<span class="w">          </span><span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">()</span>
<span class="w">              </span><span class="p">(</span><span class="nv">lyrics-fetcher-show-lyrics</span><span class="w"> </span><span class="kt">nil</span>
<span class="w">                                          </span><span class="ss">:suppress-open</span><span class="w"> </span><span class="nc">t</span>
<span class="w">                                          </span><span class="ss">:suppress-switch</span><span class="w"> </span><span class="no">nil</span><span class="p">)))</span>
 </pre>
</div>

<p>
这样一来，每次播放歌曲的时候就是去拿歌词存到本地，下次就会直接调用。
</p>

<p>
lyrics-fetcher 还可以下封面，更多操作可以去看文档。我是走的极简，所以不用封面。
</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="text-footnotes" role="doc-endnotes">
<ol>
<li id="fn:1">
<p class="footpara">
<a href="https://www.gnu.org/software/emms/" target="_blank">GNU Emms</a>
<a href="#fnr:1.1" class="footnote-backref" role="doc-backlink">↩︎</a>
<a href="#fnr:1.2" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
<li id="fn:2">
<p class="footpara">
<a href="https://emacs-china.org/t/lyrics-fetcher/18246" target="_blank">[插件推荐] lyrics-fetcher - Emacs-general - Emacs China</a>
<a href="#fnr:2.1" class="footnote-backref" role="doc-backlink">↩︎</a>
</p>
</li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
</div>
</div>
<div class="footer">
<center> The End </center></div>
</body>
</html>
